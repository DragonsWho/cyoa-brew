<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebOS v3.0 Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0078d7;
            --taskbar-bg: rgba(20, 20, 20, 0.85);
            --window-bg: rgba(245, 245, 245, 0.98);
            --text: #333;
        }

        * { box-sizing: border-box; user-select: none; }
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            height: 100vh; width: 100vw;
            background-color: #000;
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
            transition: background 0.5s;
        }

        /* --- BSOD --- */
        #bsod {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #0078d7; color: white; z-index: 999999; padding: 100px;
            font-family: 'Segoe UI', sans-serif; cursor: none;
        }
        #bsod h1 { font-size: 100px; margin: 0; font-weight: normal; }
        #bsod p { font-size: 24px; margin-top: 20px; line-height: 1.5; }
        .qr-mock { background: white; width: 100px; height: 100px; margin-top: 30px; }

        /* --- DESKTOP --- */
        #desktop {
            height: calc(100vh - 45px);
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 10px;
        }

        .desktop-icon {
            width: 90px;
            text-align: center;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            cursor: pointer;
            padding: 8px 5px;
            border-radius: 4px;
            border: 1px solid transparent; /* FIX: Prevents jumping */
            transition: background 0.1s;
        }
        .desktop-icon:hover { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); }
        .desktop-icon i { font-size: 38px; margin-bottom: 8px; display: block; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.4)); }
        .desktop-icon span { font-size: 13px; font-weight: 500; }

        /* --- WINDOWS --- */
        .window {
            position: absolute;
            background: var(--window-bg);
            border-radius: 8px;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1), 0 20px 50px rgba(0,0,0,0.4);
            display: flex; flex-direction: column;
            min-width: 300px; min-height: 200px;
            overflow: hidden;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .window.minimized { transform: translateY(100vh) scale(0); opacity: 0; transition: 0.3s; }
        .window.maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: calc(100% - 45px) !important; border-radius: 0; animation: none; }

        .window-header {
            background: #e9e9e9;
            padding: 8px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ccc;
            height: 35px;
        }
        .window-title { font-size: 13px; font-weight: 600; color: #444; display:flex; gap:10px; align-items:center; }
        .window-controls { display: flex; gap: 8px; }
        .control-btn { width: 12px; height: 12px; border-radius: 50%; border:none; cursor: pointer; }
        .btn-close { background: #ff5f56; } .btn-close:hover { filter: brightness(0.8); }
        .btn-max { background: #27c93f; }
        .btn-min { background: #ffbd2e; }

        .window-content { flex: 1; position: relative; overflow: auto; background: white; display:flex; flex-direction:column; }

        /* --- TASKBAR --- */
        #taskbar {
            position: absolute; bottom: 0; width: 100%; height: 45px;
            background: var(--taskbar-bg);
            display: flex; align-items: center; padding: 0 10px;
            z-index: 10000; backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #start-btn { 
            color: white; font-size: 22px; padding: 8px 15px; cursor: pointer; transition: 0.2s; 
        }
        #start-btn:hover { color: #00a8ff; text-shadow: 0 0 10px rgba(0,168,255,0.5); }
        
        #taskbar-apps { flex: 1; display: flex; gap: 4px; margin-left: 10px; height: 100%; align-items: center; }
        .task-item {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            color: #ddd; font-size: 18px; cursor: pointer; border-radius: 4px; position: relative;
        }
        .task-item:hover { background: rgba(255,255,255,0.1); }
        .task-item.active { background: rgba(255,255,255,0.15); box-shadow: inset 0 -2px 0 var(--primary); color: white; }

        #clock { color: white; font-size: 12px; text-align: center; margin-left: auto; width: 80px; }

        /* --- START MENU --- */
        #start-menu {
            position: absolute; bottom: -600px; left: 10px; width: 320px;
            background: rgba(30,30,30,0.95); backdrop-filter: blur(20px);
            border-radius: 8px; border: 1px solid #444;
            transition: bottom 0.25s ease-out; z-index: 9999;
            display: flex; flex-direction: column; padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #start-menu.open { bottom: 55px; }
        .start-item { padding: 12px; color: #eee; cursor: pointer; display: flex; align-items: center; gap: 15px; border-radius: 4px; }
        .start-item:hover { background: rgba(255,255,255,0.1); }

        /* --- APP STYLES --- */
        /* Snake */
        .snake-wrap { background: #222; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#0f0; font-family:monospace; }
        canvas#snakeCanvas { border: 2px solid #444; background: #000; box-shadow: 0 0 15px rgba(0,255,0,0.1); outline:none; }
        
        /* Explorer */
        .explorer-sidebar { width: 120px; background: #f0f0f0; border-right: 1px solid #ddd; padding: 10px; }
        .explorer-main { flex: 1; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); align-content: start; gap: 10px; }
        .file { display:flex; flex-direction:column; align-items:center; padding:10px; border-radius:4px; cursor:pointer; text-align:center; }
        .file:hover { background: #cce8ff; }
        .file i { font-size: 32px; margin-bottom: 5px; } .file span { font-size: 12px; word-break: break-all; }

        /* Browser */
        .url-bar { display:flex; padding:8px; background:#f0f0f0; gap:5px; border-bottom:1px solid #ccc; }
        .url-bar input { flex:1; padding:4px 10px; border-radius:15px; border:1px solid #ccc; outline:none; }
        .bookmarks { display:flex; gap:10px; padding:5px 10px; background:#e0e0e0; border-bottom:1px solid #bbb; font-size:11px; }
        .bm-item { cursor:pointer; color:#555; } .bm-item:hover { color:black; text-decoration:underline; }

        /* Image Viewer */
        .img-viewer { background: #222; display: flex; align-items: center; justify-content: center; height: 100%; }
        .img-viewer img { max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

    </style>
</head>
<body>

    <!-- BSOD Layer -->
    <div id="bsod">
        <h1>:(</h1>
        <p>Your PC ran into a problem and needs to restart. We're just collecting some error info, and then we'll restart for you.</p>
        <p>0% complete</p>
        <div style="display:flex; align-items:center; gap:20px; margin-top:50px;">
            <div class="qr-mock"></div>
            <div style="font-size:14px;">
                <p>Stop code: CRITICAL_PROCESS_DIED</p>
                <p>What failed: webos_sys32.exe</p>
            </div>
        </div>
        <button onclick="location.reload()" style="margin-top:50px; background:white; border:none; padding:10px 20px; cursor:pointer; font-weight:bold;">Force Restart</button>
    </div>

    <!-- Desktop -->
    <div id="desktop"></div>

    <!-- Start Menu -->
    <div id="start-menu">
        <h4 style="margin: 0 0 10px 10px; color:white;">Start</h4>
        <div id="start-list"></div>
    </div>

    <!-- Taskbar -->
    <div id="taskbar">
        <div id="start-btn" onclick="toggleStart()"><i class="fa-brands fa-windows"></i></div>
        <div id="taskbar-apps"></div>
        <div id="clock"></div>
    </div>

    <script>
        // --- SYSTEM STATE ---
        const sys = {
            zIndex: 100,
            bg: localStorage.getItem('webos3_bg') || 'url(https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1920&q=80)'
        };

        // --- APPS REGISTRY ---
        const apps = {
            explorer: {
                id: 'explorer', name: 'File Explorer', icon: 'fa-regular fa-folder-open', color: '#f39c12',
                init: (wid) => {
                    const html = `
                        <div style="display:flex; height:100%;">
                            <div class="explorer-sidebar">
                                <div style="margin-bottom:10px;"><i class="fa-solid fa-desktop"></i> Desktop</div>
                                <div style="margin-bottom:10px;"><i class="fa-solid fa-download"></i> Downloads</div>
                                <div style="margin-bottom:10px; color:blue;"><i class="fa-solid fa-hard-drive"></i> C: Drive</div>
                            </div>
                            <div class="explorer-main" id="files-${wid}"></div>
                        </div>`;
                    return html;
                },
                onLoad: (wid) => {
                    const files = [
                        { name: 'me.jpg', type: 'img', color: '#e67e22', icon: 'fa-image' },
                        { name: 'secret.txt', type: 'txt', color: '#95a5a6', icon: 'fa-file-lines' },
                        { name: 'System32', type: 'folder', color: '#f1c40f', icon: 'fa-folder' },
                        { name: 'Project_Alpha.pdf', type: 'pdf', color: '#e74c3c', icon: 'fa-file-pdf' }
                    ];
                    const grid = document.getElementById(`files-${wid}`);
                    
                    // Render Files
                    const render = (list) => {
                        grid.innerHTML = '';
                        list.forEach(f => {
                            const div = document.createElement('div');
                            div.className = 'file';
                            div.innerHTML = `<i class="fa-solid ${f.icon}" style="color:${f.color}"></i><span>${f.name}</span>`;
                            div.ondblclick = () => handleFileOpen(f);
                            grid.appendChild(div);
                        });
                    };

                    render(files);

                    function handleFileOpen(f) {
                        if(f.name === 'me.jpg') createWindow('viewer', 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=500&q=60');
                        else if(f.name === 'secret.txt') createWindow('notepad', "TOP SECRET\n\n1. The cake is a lie.\n2. Do not delete System32.\n3. WebOS takes over at midnight.");
                        else if(f.name === 'System32') {
                            grid.innerHTML = ''; 
                            const sysFiles = [{ name: 'delete_sys.exe', type: 'exe', color: 'red', icon: 'fa-triangle-exclamation' }];
                            // Back button
                            const back = document.createElement('div');
                            back.className = 'file';
                            back.innerHTML = '<i class="fa-solid fa-arrow-turn-up"></i><span>..</span>';
                            back.ondblclick = () => render(files);
                            grid.appendChild(back);
                            
                            sysFiles.forEach(sf => {
                                const d = document.createElement('div');
                                d.className = 'file';
                                d.innerHTML = `<i class="fa-solid ${sf.icon}" style="color:${sf.color}"></i><span>${sf.name}</span>`;
                                d.ondblclick = () => triggerBSOD();
                                grid.appendChild(d);
                            });
                        }
                    }
                }
            },
            browser: {
                id: 'browser', name: 'Chrome', icon: 'fa-brands fa-chrome', color: '#2ecc71',
                init: (wid) => `
                    <div style="display:flex; flex-direction:column; height:100%;">
                        <div class="url-bar">
                            <button onclick="document.getElementById('fr-${wid}').src = document.getElementById('fr-${wid}').src"><i class="fa-solid fa-rotate-right"></i></button>
                            <input type="text" value="https://www.wikipedia.org" onchange="document.getElementById('fr-${wid}').src = this.value">
                        </div>
                        <div class="bookmarks">
                            <span class="bm-item" onclick="document.getElementById('fr-${wid}').src='https://www.wikipedia.org'">Wikipedia</span> |
                            <span class="bm-item" onclick="document.getElementById('fr-${wid}').src='https://www.bing.com'">Bing</span> |
                            <span class="bm-item" onclick="document.getElementById('fr-${wid}').src='https://threejs.org/'">ThreeJS</span>
                        </div>
                        <iframe id="fr-${wid}" src="https://www.wikipedia.org" style="flex:1; border:none; background:white;"></iframe>
                    </div>`
            },
            notepad: {
                id: 'notepad', name: 'Notepad', icon: 'fa-solid fa-pen-to-square', color: '#3498db',
                init: (wid) => `<textarea id="note-${wid}" style="width:100%; height:100%; border:none; padding:10px; outline:none; font-family:monospace; resize:none;"></textarea>`,
                onLoad: (wid, payload) => {
                    document.getElementById(`note-${wid}`).value = payload || "Type something...";
                }
            },
            viewer: {
                id: 'viewer', name: 'Photos', icon: 'fa-regular fa-image', color: '#9b59b6',
                init: (wid) => `<div class="img-viewer" id="img-${wid}"></div>`,
                onLoad: (wid, payload) => {
                    document.getElementById(`img-${wid}`).innerHTML = `<img src="${payload || ''}">`;
                }
            },
            vscode: {
                id: 'vscode', name: 'VS Code', icon: 'fa-solid fa-code', color: '#0078d7',
                init: (wid) => `<div style="background:#1e1e1e; color:#d4d4d4; height:100%; padding:10px; font-family:monospace;">
                    <div style="color:#6a9955">// WebOS Kernel Source</div>
                    <div><span style="color:#569cd6">function</span> <span style="color:#dcdcaa">init</span>() {</div>
                    <div style="padding-left:20px"><span style="color:#9cdcfe">console</span>.<span style="color:#dcdcaa">log</span>(<span style="color:#ce9178">"Hello World"</span>);</div>
                    <div>}</div>
                </div>`
            },
            snake: {
                id: 'snake', name: 'Snake', icon: 'fa-solid fa-gamepad', color: '#e74c3c',
                init: (wid) => `<div class="snake-wrap">
                                    <div style="margin-bottom:10px;">Score: <span id="score-${wid}">0</span></div>
                                    <canvas id="cvs-${wid}" width="300" height="300"></canvas>
                                    <small style="color:#777; margin-top:10px;">Arrow Keys to Move</small>
                                </div>`,
                onLoad: (wid) => startSnake(wid)
            },
            settings: {
                id: 'settings', name: 'Settings', icon: 'fa-solid fa-gear', color: '#7f8c8d',
                init: (wid) => `<div style="padding:20px;">
                    <h3>Background</h3>
                    <div style="display:flex; gap:10px;">
                        <div onclick="changeBg('url(https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&w=1920&q=80)')" style="width:50px; height:50px; background:navy; cursor:pointer;"></div>
                        <div onclick="changeBg('url(https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80)')" style="width:50px; height:50px; background:orange; cursor:pointer;"></div>
                        <div onclick="changeBg('#333')" style="width:50px; height:50px; background:#333; cursor:pointer;"></div>
                    </div>
                </div>`
            }
        };

        // --- CORE FUNCTIONS ---

        window.onload = () => {
            document.body.style.background = sys.bg + " no-repeat center center fixed";
            document.body.style.backgroundSize = "cover";
            renderDesktop();
            renderStart();
            updateClock();
            setInterval(updateClock, 1000);
        };

        function changeBg(bg) {
            sys.bg = bg;
            localStorage.setItem('webos3_bg', bg);
            if(bg.includes('url')) {
                document.body.style.background = bg + " no-repeat center center fixed";
                document.body.style.backgroundSize = "cover";
            } else {
                document.body.style.background = bg;
            }
        }

        function renderDesktop() {
            const d = document.getElementById('desktop');
            const list = ['explorer', 'browser', 'vscode', 'snake', 'notepad', 'settings'];
            list.forEach(key => {
                const app = apps[key];
                d.innerHTML += `
                    <div class="desktop-icon" ondblclick="createWindow('${app.id}')">
                        <i class="${app.icon}" style="color:${app.color}"></i>
                        <span>${app.name}</span>
                    </div>`;
            });
        }

        function renderStart() {
            const m = document.getElementById('start-list');
            Object.values(apps).forEach(app => {
                m.innerHTML += `<div class="start-item" onclick="createWindow('${app.id}'); toggleStart()">
                                    <i class="${app.icon}" style="color:${app.color}; width:20px;"></i> ${app.name}
                                </div>`;
            });
        }

        // --- WINDOW MANAGER ---
        function createWindow(appId, payload = null) {
            const app = apps[appId];
            const wid = 'w' + Date.now();
            sys.zIndex++;

            const win = document.createElement('div');
            win.className = 'window';
            win.id = wid;
            win.style.zIndex = sys.zIndex;
            win.style.left = (50 + Math.random()*50) + 'px';
            win.style.top = (50 + Math.random()*50) + 'px';
            win.style.width = appId === 'snake' ? '340px' : '500px';
            win.style.height = appId === 'snake' ? '420px' : '350px';

            win.innerHTML = `
                <div class="window-header" onmousedown="dragStart(event, '${wid}')" ondblclick="winMax('${wid}')">
                    <div class="window-title"><i class="${app.icon}"></i> ${app.name}</div>
                    <div class="window-controls">
                        <button class="control-btn btn-min" onclick="winMin('${wid}')"></button>
                        <button class="control-btn btn-max" onclick="winMax('${wid}')"></button>
                        <button class="control-btn btn-close" onclick="winClose('${wid}')"></button>
                    </div>
                </div>
                <div class="window-content">${app.init(wid)}</div>
            `;
            
            win.onmousedown = () => winFocus(wid);
            document.body.appendChild(win);
            
            // Taskbar
            const t = document.getElementById('taskbar-apps');
            const ti = document.createElement('div');
            ti.className = 'task-item active';
            ti.id = 't-' + wid;
            ti.innerHTML = `<i class="${app.icon}"></i>`;
            ti.onclick = () => winToggle(wid);
            // Reset others
            document.querySelectorAll('.task-item').forEach(x => x.classList.remove('active'));
            t.appendChild(ti);

            if(app.onLoad) app.onLoad(wid, payload);
        }

        function winClose(wid) {
            document.getElementById(wid).remove();
            document.getElementById('t-' + wid).remove();
        }

        function winMin(wid) {
            document.getElementById(wid).classList.add('minimized');
            document.getElementById('t-' + wid).classList.remove('active');
        }

        function winMax(wid) {
            document.getElementById(wid).classList.toggle('maximized');
        }

        function winFocus(wid) {
            sys.zIndex++;
            const w = document.getElementById(wid);
            w.style.zIndex = sys.zIndex;
            w.classList.remove('minimized');
            document.querySelectorAll('.task-item').forEach(x => x.classList.remove('active'));
            document.getElementById('t-' + wid).classList.add('active');
        }

        function winToggle(wid) {
            const w = document.getElementById(wid);
            if(w.classList.contains('minimized') || w.style.zIndex != sys.zIndex) winFocus(wid);
            else winMin(wid);
        }

        // --- DRAG ---
        let drag = { active: false, id: null, offX: 0, offY: 0 };
        
        function dragStart(e, id) {
            if(e.target.closest('.control-btn')) return;
            drag = { active: true, id: id, offX: e.clientX - document.getElementById(id).offsetLeft, offY: e.clientY - document.getElementById(id).offsetTop };
        }

        window.addEventListener('mousemove', e => {
            if(!drag.active) return;
            const w = document.getElementById(drag.id);
            if(w.classList.contains('maximized')) return;
            e.preventDefault();
            w.style.top = Math.max(0, Math.min(window.innerHeight-50, e.clientY - drag.offY)) + 'px';
            w.style.left = (e.clientX - drag.offX) + 'px';
        });

        window.addEventListener('mouseup', () => drag.active = false);

        // --- FEATURES ---

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        function toggleStart() {
            document.getElementById('start-menu').classList.toggle('open');
        }

        document.getElementById('desktop').onclick = () => document.getElementById('start-menu').classList.remove('open');

        function triggerBSOD() {
            document.getElementById('bsod').style.display = 'block';
        }

        // --- SNAKE GAME (FIXED) ---
        function startSnake(wid) {
            const canvas = document.getElementById(`cvs-${wid}`);
            const ctx = canvas.getContext('2d');
            const scoreEl = document.getElementById(`score-${wid}`);
            
            const gridSize = 20;
            const tileCount = 15; // 300 / 20 = 15
            
            let velocityX = 0;
            let velocityY = 0;
            let playerX = 10;
            let playerY = 10;
            let trail = [];
            let tail = 5;
            let appleX = 5;
            let appleY = 5;
            let score = 0;
            
            // Important: Handle focus for keyboard events
            canvas.setAttribute('tabindex', '0');
            canvas.focus();

            function gameLoop() {
                if(!document.getElementById(wid)) return; // Stop if window closed

                playerX += velocityX;
                playerY += velocityY;

                // Walls (Wrap around)
                if(playerX < 0) playerX = tileCount - 1;
                if(playerX > tileCount - 1) playerX = 0;
                if(playerY < 0) playerY = tileCount - 1;
                if(playerY > tileCount - 1) playerY = 0;

                // Background
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Snake
                ctx.fillStyle = 'lime';
                for(let i=0; i<trail.length; i++) {
                    ctx.fillRect(trail[i].x * gridSize, trail[i].y * gridSize, gridSize-2, gridSize-2);
                    if(trail[i].x === playerX && trail[i].y === playerY && (velocityX!==0 || velocityY!==0)) {
                        tail = 5; score = 0; scoreEl.innerText = "0 (Reset)";
                    }
                }

                trail.push({x: playerX, y: playerY});
                while(trail.length > tail) {
                    trail.shift();
                }

                // Apple
                if(appleX === playerX && appleY === playerY) {
                    tail++;
                    score += 10;
                    scoreEl.innerText = score;
                    appleX = Math.floor(Math.random() * tileCount);
                    appleY = Math.floor(Math.random() * tileCount);
                }

                ctx.fillStyle = 'red';
                ctx.fillRect(appleX * gridSize, appleY * gridSize, gridSize-2, gridSize-2);
            }

            function keyPush(evt) {
                if(document.activeElement !== canvas) return;
                switch(evt.keyCode) {
                    case 37: if(velocityX !== 1) { velocityX = -1; velocityY = 0; } break;
                    case 38: if(velocityY !== 1) { velocityX = 0; velocityY = -1; } break;
                    case 39: if(velocityX !== -1) { velocityX = 1; velocityY = 0; } break;
                    case 40: if(velocityY !== -1) { velocityX = 0; velocityY = 1; } break;
                }
                evt.preventDefault();
            }

            document.addEventListener("keydown", keyPush);
            const interval = setInterval(gameLoop, 1000/10); // 10 FPS
            
            // Cleanup on window close override
            const originalClose = document.querySelector(`#${wid} .btn-close`).onclick;
            document.querySelector(`#${wid} .btn-close`).onclick = () => {
                clearInterval(interval);
                document.removeEventListener("keydown", keyPush);
                winClose(wid);
            };
        }
    </script>
</body>
</html>