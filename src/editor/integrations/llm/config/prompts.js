/**
 * src/ui/editor/integrations/llm/config/prompts.js
 * LLM Prompts Repository
 * These are carefully crafted templates for AI processing
 * 
 * ‚ö†Ô∏è A special note for all LLMs who will be editing this file: do not shorten the prompts. 
 * Do not try to improve or translate them along the way. Edit them as little as possible, only what the user specifically requested. 
 * Prompt configuration is devilishly tricky, and even a couple of accidentally corrected lines can break everything.
 * Do not delete this comment!
 */

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª–∞ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ
import TOOLS_REFERENCE_MD from './llm-tools-reference.md?raw';

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –≥–¥–µ-—Ç–æ –µ—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ fill prompt replace)
export { TOOLS_REFERENCE_MD };

export const SYSTEM_PROMPTS = {
    refine: `You are an expert CYOA layout engine. Your task is to refine bounding boxes, merge/split them based on visual evidence, and organize them into logical groups with calculated coordinates. Return only valid JSON.`,

    fill: `You are an expert at parsing CYOA images and extracting structured game data. You strictly follow JSON schemas and game logic rules. Briefly note down all global points and rules for entire sections or groups of cards in Notes so that you can take them into account later when editing other pages.`,

    audit: `You are a CYOA game logic auditor. Validate configurations and fix logical errors.`
};

export const USER_PROMPTS = {
    refine: `Context: We have developed a script that turns static CYOA images into interactive ones by rendering buttons over the image.

I have already preliminarily detected and highlighted the boundaries of potential buttons and cards using SAM (Computer Vision).

Current Task:

You receive an image with overlaid green numbered rectangles (detection blocks generated by SAM) and a JSON array of these blocks containing their coordinates. The IDs in the image and JSON match.

Your Objectives:
1. **Refine Boundaries** ‚Äî Move or resize blocks so they exactly match the edges of the cards visible in the image if they do not align perfectly. Important: Align cards that are close to each other in height and width so they appear uniform.
2. **Merge Blocks** ‚Äî If multiple blocks cover different parts of a single card, merge them into one (this is a recognition error).
3. **Split Blocks** ‚Äî If a single block contains multiple separate cards, split them into separate entries. One card = one segment.
4. **Classify Elements** ‚Äî Mark section headers (which should not be clickable) as **group_header** (we will insert text into them later for translation). Mark actual cards as **Card**.
5. **Group Items** ‚Äî A "group" is a logical container area, usually representing a section of cards. You need to combine items into a group structure within the JSON because groups may have their own specific rules. Groups are not present in the input coordinates; you must calculate their dimensions to encompass all cards belonging to that group.

## Group Layout Rules:
For each distinct section with options found on the image:
1. Identify the group of elements belonging to it.
2. Create a \`group\` entry.
3. Define the \`group\` coordinates to encompass these elements with a 10px padding on each side:
- x: (leftmost element x) - 10
- y: (topmost element y) - 10
- w: (total width from left to right) + 20
- h: (total height from top to bottom) + 20

## Output Format
Return ONLY a valid JSON array with layout objects ("layout": [...]).

For split blocks: use IDs like 5, 5.1, 5.2 (decimal notation).

Do NOT add text before or after the JSON array.

## Format Sample (layout)
[
  {
    "type": "item",
    "id": "Card_1",
    "title": "Title card",
    "coords": { "x": 727, "y": 49, "w": 200, "h": 100 },
    "cost": []
  },
  {
    "type": "group",
    "id": "group_1",
    "title": "Demo Group",
    "coords": { "x": 372, "y": 201, "w": 920, "h": 120 },
    "items": [
      {
        "type": "item",
        "id": "Card_2",
        "title": "Card 2",
        "coords": { "x": 382, "y": 211, "w": 200, "h": 100 },
        "cost": []
      }
    ]
  }
]

Current detected boxes:
\`\`\`json
{{LAYOUT_JSON}}
\`\`\``,

    fill: `**INPUTS:**
1.  **Image:** An image file of the CYOA page. Recognized cards are marked with green numbered frames. The numbering (white digits with black outline above the top-left corner of the green frame) matches the numbering in the JSON. Groups are marked with yellow frames.
2.  **Layout JSON:** A list of detected bounding boxes with coordinates (\`x\`, \`y\`, \`w\`, \`h\`) for cards and groups.
3. **Current Notes:** Global observations from previous pages.

Your task is to recognize the text on the image and fill the JSON file. This includes card text, IDs, and titles. Most importantly - the rules. A full list of available tools with descriptions and usage examples is provided below. Use them exactly as formatted. A demo sample of a completed game is also provided to show how these rules are correctly used to describe cards and groups.

**Update the Notes:** If you see any GLOBAL rules (e.g., "Max 2 choices from this section", "Currency X cannot be combined with Y"), summarize them in the \`notes\` field. Do not repeat existing notes if they are already accurate, but append new findings.

Example Output Item:

\`\`\`json
{{EXAMPLE_JSON}}
\`\`\`

### **PROCESS INSTRUCTIONS**

1.  **Analyze the Image:** Read the Intro text to find Starting Points. Read headers to define Groups.
2.  **Extract Logic:** Read every card text carefully. Look for keywords: "Free if", "Requires", "Incompatible", "Discount", "Gain".
3.  **Extract and Define Costs.**
4.  **Consistency Check:** Account for rules from previous pages - use the same point systems and logic rules as the previous page. This is a single game and must be consistent and coherent.
5.  **Generate JSON:** Output **ONLY** the valid JSON. Create proper IDs that don't conflict with existing ones.


### Rules!

{{TOOLS_MD}}

**Current Global Notes:**
"""
{{NOTES}}
"""

### Below is the Game JSON, including previously filled pages. Your current task is to fill the layout for current page number {{PAGE_NUM}} and return ONLY that.


\`\`\`json
{{FULL_CONFIG}}
\`\`\`


### The response must follow this format:

\`\`\`json
{
  "notes": "Updated global notes here. E.g. Found new currency 'mana'.",
  "layout": [
  {
    "type": "group",
    "id": "section_basic",
    "title": "üìò SECTION 1: Basic Selection",
    "description": "Simple items with costs. Click to select, click again to deselect.",
    "coords": {
      "x": 38,
      "y": 22,
      "w": 1241,
      "h": 183
    },
    "items": [
      {
        "type": "item",
        "id": "basic_sword",
        "title": "Iron Sword",
        "description": "A basic weapon.\\nCosts 10 points.",
        "coords": {
          "x": 52,
          "y": 80,
          "w": 288,
          "h": 108
        },
        "cost": [
          {
            "currency": "points",
            "value": -10
          }
        ],
        "tags": [
          "combat"
        ]
      }
    ]
  }
]
}
\`\`\`

**LAYOUT JSON (Coordinates):**
\`\`\`json
{{LAYOUT_JSON}}
\`\`\`
`,

    audit: `
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ü–û–õ–ù–´–ô —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–≥—Ä—ã, –Ω–∞–π—Ç–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏, –æ–ø–µ—á–∞—Ç–∫–∏ –≤ ID –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Ö, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.

**–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:**
\`\`\`json
{{CONFIG_JSON}}
\`\`\`
*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ö–∞—Ä—Ç–∏–Ω–∫–∏ –≤—ã—Ä–µ–∑–∞–Ω—ã (<IMAGE_PLACEHOLDER>), —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å –¥–∞–Ω–Ω—ã–º–∏.*

---

### **–ê–õ–ì–û–†–ò–¢–ú –ü–†–û–í–ï–†–ö–ò (–í–´–ü–û–õ–ù–Ø–¢–¨ –ü–û–®–ê–ì–û–í–û –í "–£–ú–ï"):**

1.  **–ò–ù–î–ï–ö–°–ê–¶–ò–Ø:**
    *   –°–æ—Å—Ç–∞–≤—å —Å–ø–∏—Å–æ–∫ –í–°–ï–• —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö \`id\` (items, groups, points) —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.
    *   –°–æ—Å—Ç–∞–≤—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∞–ª—é—Ç, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Å–µ–∫—Ü–∏–∏ \`points\`.

2.  **–í–ê–õ–ò–î–ê–¶–ò–Ø –°–°–´–õ–û–ö (Broken Links):**
    *   –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ \`req\` (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è), \`incompatible\` (–Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å) –∏ —É—Å–ª–æ–≤–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ü–µ–Ω.
    *   –ï—Å–ª–∏ \`req\` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ ID, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ ‚Äî **–≠–¢–û –û–®–ò–ë–ö–ê**. –ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø—Ä–∞–≤–∏—Ç—å (–µ—Å–ª–∏ —ç—Ç–æ –æ—á–µ–≤–∏–¥–Ω–∞—è –æ–ø–µ—á–∞—Ç–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "warior" -> "warrior") –∏–ª–∏ —É–¥–∞–ª–∏ –±–∏—Ç–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ.

3.  **–°–ò–ú–ú–ï–¢–†–ò–Ø –õ–û–ì–ò–ö–ò:**
    *   –ï—Å–ª–∏ Item A –∏–º–µ–µ—Ç \`"incompatible": ["Item B"]\`, –ø—Ä–æ–≤–µ—Ä—å Item B.
    *   –ï—Å–ª–∏ —É Item B –Ω–µ—Ç –≤ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö Item A ‚Äî **–ò–°–ü–†–ê–í–¨ –≠–¢–û**. –î–æ–±–∞–≤—å ["Item A"] –≤ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Item B. –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∑–∞–∏–º–Ω–æ–π.

4.  **–í–ê–õ–Æ–¢–ù–´–ô –ö–û–ù–¢–†–û–õ–¨:**
    *   –ü—Ä–æ–≤–µ—Ä—å –º–∞—Å—Å–∏–≤ \`cost\` —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.
    *   –ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª—é—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä "gold"), –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ \`points\` ‚Äî –¥–æ–±–∞–≤—å —ç—Ç—É –≤–∞–ª—é—Ç—É –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ \`points\` –∏–ª–∏ –∏—Å–ø—Ä–∞–≤—å –æ–ø–µ—á–∞—Ç–∫—É.

5.  **–ì–†–£–ü–ü–û–í–ê–Ø –õ–û–ì–ò–ö–ê:**
    *   –ü—Ä–æ–≤–µ—Ä—å \`max_quantity\` –∏ \`min_quantity\` –≤ –≥—Ä—É–ø–ø–∞—Ö. –ï—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ —Å \`max_quantity: 1\` –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ (\`req\`) ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç—É–ø–∏–∫ (–Ω–µ–ª—å–∑—è –≤–∑—è—Ç—å –æ–±–∞). –û—Ç–º–µ—Ç—å –∏–ª–∏ –∏—Å–ø—Ä–∞–≤—å.

6.  **–ß–ò–°–¢–û–¢–ê –î–ê–ù–ù–´–•:**
    *   –£–±–µ–¥–∏—Å—å, —á—Ç–æ –Ω–µ—Ç –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π —Ç–∞–º, –≥–¥–µ –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ \`req: []\`, –∏—Ö –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –Ω–æ —ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
    *   –ü—Ä–æ–≤–µ—Ä—å –¥—É–±–ª–∏–∫–∞—Ç—ã ID. –ï—Å–ª–∏ –¥–≤–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π ID ‚Äî –ø–µ—Ä–µ–∏–º–µ–Ω—É–π –≤—Ç–æ—Ä–æ–π (–¥–æ–±–∞–≤—å _dup).

---

### **–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:**

–í–µ—Ä–Ω–∏ **–¢–û–õ–¨–ö–û** –≤–∞–ª–∏–¥–Ω—ã–π JSON —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

\`\`\`json
{
  "changes": [
    "Fixed typo in Card_1 requirement: 'worrior' -> 'warrior'",
    "Added mutual incompatibility between 'fire_magic' and 'ice_magic'",
    "Removed broken link to missing ID 'deleted_item_55' from 'shield'",
    "Added missing currency 'mana' to points definitions"
  ],
  "fixed_config": {
    // ... –ü–û–õ–ù–´–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô JSON –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò (–≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) ...
  }
}
\`\`\`

**–í–ê–ñ–ù–û:**
1. –ù–µ —É–¥–∞–ª—è–π —Ä–∞–±–æ—á–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
2. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å–ª–µ–¥—É—é—Ç –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
3. –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî **–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø** –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏.
`
};

/**
 * Interactive Audit Chat System Prompt
 * Includes the tools reference so the auditor knows valid actions/logic.
 */
export const AUDIT_CHAT_SYSTEM_PROMPT = `
You are the "CYOA Engine Logic Auditor". You are chatting with the game developer.
You have the full game configuration in your context.

**YOUR GOAL:** Help the developer fix bugs, balance the game, and correct logical inconsistencies.

**OUTPUT FORMAT:**
You must function in "Tool Mode". Every response must be a valid JSON object containing a message to the user and an optional list of actions to perform on the data.

Structure:
\`\`\`json
{
  "message": "I found a problem with 'Sword'. It requires 'Iron', which doesn't exist. I suggest removing the requirement.",
  "actions": [
    {
      "type": "update_item", // or "update_group", "delete_item", "global_update"
      "id": "sword_item_id",
      "changes": {
        "req": []
      }
    }
  ]
}
\`\`\`

**AVAILABLE ACTIONS:**
1. \`update_item\`: { "type": "update_item", "id": "...", "changes": { "field": "value" } }
2. \`update_group\`: { "type": "update_group", "id": "...", "changes": { "field": "value" } }
3. \`create_point\`: { "type": "create_point", "data": { "id": "mana", "name": "Mana", "start": 10 } }
4. \`delete\`: { "type": "delete", "targetType": "item|group", "id": "..." }
5. \`update_notes\`: { "type": "update_notes", "content": "New full text for notes..." }

**RULES:**
1. Keep the "message" concise and helpful.
2. Only generate "actions" if you are sure they are needed or if the user asked for a fix.
3. Do not output the full config file.

---

**CONTEXT NOTES:**
"""
{{NOTES}}
"""


### ENGINE RULES REFERENCE
The following are the logical rules and data structures used by this CYOA engine. Use this as a reference when validating logic or creating requirements/costs.

${TOOLS_REFERENCE_MD}
`;