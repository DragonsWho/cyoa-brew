<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CYOA Player v5.0 (Translation Ready)</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: #eee; font-family: 'Segoe UI', sans-serif; padding-bottom: 120px; }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .top-controls {
            position: fixed; top: 10px; right: 10px; z-index: 3000;
            display: flex; gap: 10px;
        }
        .ctrl-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 5px 10px; cursor: pointer; opacity: 0.8; font-weight: bold;
            font-size: 14px;
        }
        .ctrl-btn:hover { opacity: 1; background: #444; }
        .ctrl-btn.active { background: #0055aa; border-color: #0077cc; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü */
        #game-wrapper {
            position: relative; 
            max-width: 100%; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column;
            align-items: center;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page-container {
            position: relative;
            margin-bottom: 0px;
            line-height: 0;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            max-width: 100%;
        }
        
        .page-image {
            display: block; 
            max-width: 100%; 
            height: auto; 
            user-select: none;
        }

        .page-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10;
        }

        /* --- BASIC CLICK ZONE --- */
        .click-zone {
            position: absolute; cursor: pointer; z-index: 100;
            box-sizing: border-box;
            border-radius: 12px;
            transition: background 0.2s, box-shadow 0.2s;
            overflow: hidden; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∑–∞ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* –¢–µ–∫—Å—Ç –ø—Ä–∏–∂–∏–º–∞–µ–º –∫ –Ω–∏–∑—É */
        }
        .click-zone:hover { 
            background: rgba(255, 255, 255, 0.07); 
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        .click-zone.selected {
            background: rgba(0, 255, 0, 0.1); 
            border: none;
            box-shadow: 0 0 15px 2px #0f0, inset 0 0 20px 5px rgba(0, 255, 0, 0.3);
        }
        .click-zone.disabled {
            cursor: not-allowed;
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.4), rgba(0,0,0,0.4) 10px, rgba(50,50,50,0.6) 10px, rgba(50,50,50,0.6) 20px);
            box-shadow: inset 0 0 20px 10px rgba(0,0,0,0.8), 0 0 20px 5px rgba(0,0,0,0.9);
        }

        /* --- TEXT TRANSLATION LAYER --- */
        .text-content {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            background: rgba(0, 0, 0, 0.85); /* –¢–µ–º–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            color: #ddd;
            padding: 10px;
            font-size: 14px; /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –º–æ–∂–Ω–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å */
            line-height: 1.4;
            max-height: 100%; /* –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ */
            overflow-y: auto;
            pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –ø—Ä–æ–±–∏–≤–∞–ª –∫–Ω–æ–ø–∫—É */
            text-shadow: none;
            backdrop-filter: blur(2px);
            border-top: 1px solid #444;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .text-content strong {
            display: block;
            color: #fff;
            font-size: 1.1em;
            margin-bottom: 4px;
            border-bottom: 1px solid #555;
            padding-bottom: 2px;
        }

        /* –í–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ï–ö–°–¢–ê (–∫–ª–∞—Å—Å –Ω–∞ body) */
        body.text-mode .text-content {
            display: block;
        }
        /* –í —Ä–µ–∂–∏–º–µ —Ç–µ–∫—Å—Ç–∞ –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –µ–≥–æ –∫—É—Ä—Å–æ—Ä–æ–º, 
           –Ω–æ –∫–ª–∏–∫ –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å (–ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞) */
        body.text-mode .text-content {
            pointer-events: auto; 
        }

        /* --- LOCAL BUDGET BADGE --- */
        .group-budget-badge {
            position: absolute;
            transform: translate(-50%, -50%); 
            background: #000; 
            border: 2px solid #ffd700; 
            color: #ffd700;
            padding: 8px 25px;
            border-radius: 8px; 
            font-weight: 800; 
            font-family: 'Segoe UI', Tahoma, sans-serif;
            font-size: 22px; 
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 200; 
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 
                0 0 20px 2px rgba(255, 215, 0, 0.6),    
                inset 0 0 20px rgba(255, 215, 0, 0.2);  
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            transition: all 0.3s ease;
        }

        .group-budget-badge.empty {
            border-color: #444;
            color: #666;
            background: rgba(0,0,0,0.8);
            box-shadow: none;
            text-shadow: none;
        }

        /* DEBUG STYLES */
        body.debug-mode .click-zone {
            border: 1px solid rgba(255, 0, 0, 0.8) !important;
            background: rgba(255, 0, 0, 0.1) !important;
            border-radius: 0 !important; 
            box-shadow: none !important;
        }
        body.debug-mode .click-zone::after {
            content: attr(id); position: absolute; top: 0; left: 0; background: red; color: white; font-size: 10px; padding: 2px; z-index: 101;
        }
        .info-zone { z-index: 50; pointer-events: none; border: none; }
        /* –í —Ä–µ–∂–∏–º–µ —Ç–µ–∫—Å—Ç–∞ info-zone —Ç–æ–∂–µ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç */
        .info-zone .text-content { pointer-events: auto; }
        body.debug-mode .info-zone { border: 2px dashed orange !important; background: rgba(255, 165, 0, 0.2) !important; }

        /* POINTS BAR */
        #points-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: linear-gradient(0deg, rgba(16,16,16,1) 0%, rgba(16,16,16,0.95) 100%);
            border-top: 1px solid #333; padding: 15px; display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.8); z-index: 2000;
        }
        .currency { font-size: 1.2em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .currency span { color: #00ff88; font-family: monospace; font-size: 1.3em; text-shadow: 0 0 5px rgba(0,255,100,0.5); }
        .currency.negative span { color: #ff4444; text-shadow: 0 0 5px rgba(255,50,50,0.5); }

        #tooltip {
            position: fixed; z-index: 3000; background: rgba(10, 10, 10, 0.95); 
            border: 1px solid #444; padding: 15px; border-radius: 8px; pointer-events: none;
            font-size: 0.95em; max-width: 380px; line-height: 1.5; box-shadow: 0 10px 40px rgba(0,0,0,1);
            backdrop-filter: blur(8px); color: #ccc; opacity: 0; transition: opacity 0s; pointer-events: none;
        }
        #tooltip.visible { opacity: 1; transition: opacity 0.2s ease; }
        #tooltip h4 { margin: 0 0 8px 0; color: #fff; font-size: 1.1em; border-bottom: 1px solid #333; padding-bottom: 6px;}
        #tooltip .desc { margin-top: 6px; color: #bbb; font-size: 0.9em; white-space: pre-wrap; display: none; }
        body.debug-mode #tooltip .desc { display: block; }
        #tooltip .cost { color: #0f0; font-weight: bold; margin-top: 8px; font-size: 1.05em; display: flex; justify-content: space-between;}
        #tooltip .cost.bad { color: #f66; }
        #tooltip .cost.free { color: #ffd700; } 
        #tooltip .reqs { margin-top: 10px; padding-top: 5px; border-top: 1px solid #333; font-size: 0.85em; }
        .req-item { display: block; margin-bottom: 2px; }
        .req-item.ok { color: #666; text-decoration: line-through; }
        .req-item.fail { color: #f88; font-weight: bold; }
        .req-item.missing { color: #fa0; }
        #tooltip .debug-info { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #555; color: #777; font-family: monospace; font-size: 0.75em; }
    </style>
</head>
<body>

<div class="top-controls">
    <button id="text-toggle" class="ctrl-btn" onclick="toggleText()">Translate Mode</button>
    <!--<button id="debug-toggle" class="ctrl-btn" onclick="toggleDebug()">üêû Debug</button>-->
</div>

<!-- –°—é–¥–∞ JS –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div id="game-wrapper"></div>

<div id="points-bar"></div>
<div id="tooltip"></div>

<script>
    let config = null;
    let state = { selected: new Set(), currencies: {} };
    let pageDimensions = []; 
    let tooltipTimer = null;
    let hoveredItem = null; 
    let hoveredGroup = null;

    function toggleDebug() { 
        document.body.classList.toggle('debug-mode');
        document.getElementById('debug-toggle').classList.toggle('active');
        if(hoveredItem) updateTooltipContent(hoveredItem, hoveredGroup);
    }

    function toggleText() {
        document.body.classList.toggle('text-mode');
        document.getElementById('text-toggle').classList.toggle('active');
    }

    async function init() {
        try {
            const resp = await fetch('cyoa_config.json');
            if (!resp.ok) throw new Error("Config not found");
            config = await resp.json();
            await buildPages();
        } catch (e) {
            console.error(e);
            alert("Error loading config. See console.");
        }
    }

    async function buildPages() {
        const wrapper = document.getElementById('game-wrapper');
        const bar = document.getElementById('points-bar');
        wrapper.innerHTML = ''; 
        bar.innerHTML = '';
        pageDimensions = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—á–∫–æ–≤
        config.points.forEach(p => {
            const div = document.createElement('div');
            div.className = 'currency';
            div.id = `curr-${p.id}`;
            div.innerHTML = `${p.name}: <span>${p.start}</span>`;
            bar.appendChild(div);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        const loadPromises = config.meta.pages.map((src, index) => {
            return new Promise((resolve) => {
                const container = document.createElement('div');
                container.className = 'page-container';
                container.id = `page-container-${index}`;

                const img = document.createElement('img');
                img.className = 'page-image';
                img.src = src;
                
                const layer = document.createElement('div');
                layer.className = 'page-layer';
                layer.id = `layer-page-${index}`;

                container.appendChild(img);
                container.appendChild(layer);
                wrapper.appendChild(container);

                img.onload = () => {
                    pageDimensions[index] = { w: img.naturalWidth, h: img.naturalHeight };
                    resolve();
                };
                img.onerror = () => {
                    pageDimensions[index] = { w: 1000, h: 1000 };
                    resolve();
                };
            });
        });

        await Promise.all(loadPromises);
        renderButtons();
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Å —Ç–µ–∫—Å—Ç–æ–º
    function createTextLayer(title, desc) {
        const div = document.createElement('div');
        div.className = 'text-content';
        // –ó–∞–º–µ–Ω—è–µ–º \n –Ω–∞ <br> –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–±–∑–∞—Ü–µ–≤
        const cleanDesc = desc ? desc.replace(/\n/g, '<br>') : '';
        div.innerHTML = `<strong>${title}</strong><span>${cleanDesc}</span>`;
        return div;
    }

    function renderButtons() {
        config.groups.forEach(group => {
            const pageIndex = group.page !== undefined ? group.page : 0;
            const layer = document.getElementById(`layer-page-${pageIndex}`);
            const dim = pageDimensions[pageIndex];

            if (!layer || !dim) return;

            const getStyle = (coords) => {
                if (!coords) return { display: 'none' };
                let raw = Array.isArray(coords) ? 
                    { x: coords[0], y: coords[1], w: coords[2], h: coords[3] } : 
                    { x: coords.x, y: coords.y, w: coords.w, h: coords.h };
                
                const isPixels = raw.x > 100 || raw.y > 100 || raw.h > 100;
                return {
                    left: (isPixels ? (raw.x / dim.w) * 100 : raw.x) + '%',
                    top: (isPixels ? (raw.y / dim.h) * 100 : raw.y) + '%',
                    width: (isPixels ? (raw.w / dim.w) * 100 : raw.w) + '%',
                    height: (isPixels ? (raw.h / dim.h) * 100 : raw.h) + '%'
                };
            };

            // –ë–µ–π–¥–∂ –±—é–¥–∂–µ—Ç–∞
            if (group.rules && group.rules.budget && group.coords) {
                const badge = document.createElement('div');
                badge.className = 'group-budget-badge';
                badge.id = `budget-${group.id}`;
                const style = getStyle(group.coords);
                const leftVal = parseFloat(style.left);
                const widthVal = parseFloat(style.width);
                const topVal = parseFloat(style.top);
                badge.style.left = (leftVal + (widthVal / 2)) + '%';
                badge.style.top = topVal + '%';
                layer.appendChild(badge);
            }

            // –ó–æ–Ω–∞ –≥—Ä—É–ø–ø—ã (–¥–ª—è —Ç—É–ª—Ç–∏–ø–æ–≤ –∏–ª–∏ –æ—Ç–ª–∞–¥–∫–∏)
            if (group.coords) {
                const groupEl = document.createElement('div');
                groupEl.className = 'click-zone info-zone';
                groupEl.id = `group-${group.id}`;
                Object.assign(groupEl.style, getStyle(group.coords));
                groupEl.title = group.title; 
                
                // –í—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ)
                if (group.description) {
                    groupEl.appendChild(createTextLayer(group.title, group.description));
                }

                layer.appendChild(groupEl);
            }

            // –ö–Ω–æ–ø–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            group.items.forEach(item => {
                if (!item.coords) return;
                const el = document.createElement('div');
                el.className = 'click-zone item-zone';
                el.id = `btn-${item.id}`;
                Object.assign(el.style, getStyle(item.coords));

                // === –í–°–¢–ê–í–ö–ê –¢–ï–ö–°–¢–ê –î–õ–Ø –ü–ï–†–ï–í–û–î–ê ===
                el.appendChild(createTextLayer(item.title, item.description));

                el.onclick = (e) => {
                    // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É —Å–ª–æ—é - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –µ–≥–æ,
                    // –Ω–æ —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º pointer-events:auto –ø—Ä–∏ —Ä–µ–∂–∏–º–µ —Ç–µ–∫—Å—Ç–∞,
                    // —Å–æ–±—ã—Ç–∏–µ –≤—Å–ø–ª—ã–≤–µ—Ç —Å—é–¥–∞.
                    handleClick(item, group);
                };
                
                el.onmouseenter = (e) => {
                    hoveredItem = item;
                    hoveredGroup = group;
                    updateTooltipContent(item, group);
                    updateTooltipPosition(e); 
                    tooltipTimer = setTimeout(() => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Ç–µ–∫—Å—Ç–∞
                        // (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –æ–¥–Ω–æ –¥—Ä—É–≥–∏–º)
                        if (!document.body.classList.contains('text-mode')) {
                            document.getElementById('tooltip').classList.add('visible');
                        }
                    }, 500); 
                };
                el.onmousemove = (e) => updateTooltipPosition(e);
                el.onmouseleave = () => {
                    clearTimeout(tooltipTimer);
                    hoveredItem = null;
                    hoveredGroup = null;
                    document.getElementById('tooltip').classList.remove('visible');
                };
                layer.appendChild(el);
            });
        });
        recalculate();
    }

    function handleClick(item, group) {
        if (state.selected.has(item.id)) {
            state.selected.delete(item.id);
        } else {
            if (!checkReqs(item)) return; 
            const rules = group.rules || {};
            const limit = rules.max_choices; 
            if (limit) {
                const selectedInGroup = group.items.filter(i => state.selected.has(i.id));
                if (limit === 1) {
                    selectedInGroup.forEach(i => state.selected.delete(i.id));
                } else {
                    if (selectedInGroup.length >= limit) return; 
                }
            }
            state.selected.add(item.id);
        }
        recalculate();
        if (hoveredItem && hoveredItem.id === item.id) updateTooltipContent(item, group);
    }

    // –•–µ–ª–ø–µ—Ä –¥–ª—è eval
    function runEval(code) {
        const has = (id) => state.selected.has(id);
        const isFree = (groupId, limit) => {
             const g = config.groups.find(gr => gr.id === groupId);
             if(!g) return false;
             const count = g.items.filter(i => state.selected.has(i.id)).length;
             return count <= limit;
        };
        try { return eval(code); } catch(e) { console.error("Eval error", code, e); return false; }
    }

    function checkReqs(item) {
        if (item.incompatible) {
            for (let bad of item.incompatible) {
                if (state.selected.has(bad)) return false;
            }
        }
        if (item.requirements) {
            for (let req of item.requirements) {
                if (req.includes('(') || req.includes('||') || req.includes('&&')) {
                    if (!runEval(req)) return false;
                } else {
                    if (req.startsWith('!')) {
                        if (state.selected.has(req.slice(1))) return false;
                    } else {
                        if (!state.selected.has(req)) return false;
                    }
                }
            }
        }
        return true;
    }

    function recalculate() {
        // 1. –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        let changed = true;
        while (changed) {
            changed = false;
            const currentSelected = Array.from(state.selected);
            for (let id of currentSelected) {
                let item = null;
                for (let g of config.groups) {
                    item = g.items.find(i => i.id === id);
                    if (item) break;
                }
                if (item && !checkReqs(item)) {
                    state.selected.delete(id);
                    changed = true;
                }
            }
        }

        // 2. –°–±—Ä–æ—Å –≤–∞–ª—é—Ç
        config.points.forEach(p => state.currencies[p.id] = p.start);

        // 3. –ü–æ–¥—Å—á–µ—Ç —Å—ã—Ä—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
        let groupDeltas = {}; 
        state.selected.forEach(selectedId => {
            let item, group;
            for(let g of config.groups) {
                const f = g.items.find(i => i.id === selectedId);
                if(f) { item = f; group = g; break; }
            }
            if(!item || !item.cost) return;

            if (!groupDeltas[group.id]) groupDeltas[group.id] = {};
            item.cost.forEach(c => {
                let val = c.value;
                if (c.condition) val += runEval(c.condition);
                if (!groupDeltas[group.id][c.currency]) groupDeltas[group.id][c.currency] = 0;
                groupDeltas[group.id][c.currency] += val; 
            });
        });

        // 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ë–Æ–î–ñ–ï–¢–û–í
        config.groups.forEach(g => {
            if (g.rules && g.rules.budget) {
                const b = g.rules.budget;
                let targetGroups = [g.id];
                if (b.applies_to && Array.isArray(b.applies_to)) {
                    targetGroups = targetGroups.concat(b.applies_to);
                }
                let totalSpent = 0;
                targetGroups.forEach(tid => {
                    if (groupDeltas[tid] && groupDeltas[tid][b.currency]) {
                        if (groupDeltas[tid][b.currency] < 0) {
                            totalSpent += Math.abs(groupDeltas[tid][b.currency]);
                        }
                    }
                });
                const covered = Math.min(totalSpent, b.amount);
                let remainingCoverage = covered;
                targetGroups.forEach(tid => {
                    if (remainingCoverage <= 0) return;
                    if (groupDeltas[tid] && groupDeltas[tid][b.currency] < 0) {
                        const debt = Math.abs(groupDeltas[tid][b.currency]);
                        const pay = Math.min(debt, remainingCoverage);
                        groupDeltas[tid][b.currency] += pay;
                        remainingCoverage -= pay;
                    }
                });
                const badge = document.getElementById(`budget-${g.id}`);
                if(badge) {
                    const left = b.amount - covered;
                    badge.innerText = `${b.name || b.currency}: ${left}/${b.amount}`;
                    badge.className = left === 0 ? 'group-budget-badge empty' : 'group-budget-badge';
                }
            }
        });

        // 5. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
        for(let gid in groupDeltas) {
            for(let cid in groupDeltas[gid]) {
                if(state.currencies[cid] !== undefined) {
                    state.currencies[cid] += groupDeltas[gid][cid];
                }
            }
        }

        // 6. UI –û–±–Ω–æ–≤–ª–µ–Ω–∏—è
        document.querySelectorAll('.click-zone.item-zone').forEach(el => {
            const id = el.id.replace('btn-', '');
            const isSelected = state.selected.has(id);
            if (isSelected) el.classList.add('selected');
            else el.classList.remove('selected');
            
            let itemObj = null, groupObj = null;
            for(let g of config.groups) {
                 const f = g.items.find(i => i.id === id);
                 if(f) { itemObj = f; groupObj = g; break; }
            }
            let isDisabled = false;
            if (itemObj && !checkReqs(itemObj)) isDisabled = true;
            if (itemObj && !isSelected && groupObj && groupObj.rules && groupObj.rules.max_choices) {
                 const currentCount = groupObj.items.filter(i => state.selected.has(i.id)).length;
                 if (currentCount >= groupObj.rules.max_choices) isDisabled = true;
            }
            if (isDisabled) el.classList.add('disabled');
            else el.classList.remove('disabled');
        });

        // 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—Ä–∞ –æ—á–∫–æ–≤
        for (let cid in state.currencies) {
            const span = document.querySelector(`#curr-${cid} span`);
            if(span) {
                const val = state.currencies[cid];
                span.innerText = val;
                if(val < 0) span.parentElement.classList.add('negative');
                else span.parentElement.classList.remove('negative');
            }
        }
    }

    function getItemTitle(id) {
        const cleanId = id.replace(/['"()]/g, '').trim(); 
        for (const g of config.groups) {
            const found = g.items.find(i => i.id === cleanId);
            if (found) return found.title;
        }
        return cleanId;
    }

    function updateTooltipContent(item, group) {
        const tt = document.getElementById('tooltip');
        const isDebug = document.body.classList.contains('debug-mode');

        let html = `<h4>${item.title}</h4>`;
        
        // --- –¶–ï–ù–ê ---
        if (item.cost && item.cost.length > 0) {
            item.cost.forEach(c => {
                let finalVal = c.value;
                if (c.condition) finalVal += runEval(c.condition);
                const sign = finalVal > 0 ? '+' : '';
                let colorClass = finalVal < 0 ? 'bad' : '';
                if(finalVal === 0) colorClass = 'free'; 
                html += `<div class="cost ${colorClass}">${c.currency}: ${sign}${finalVal}</div>`;
            });
        }
        
        let reqsHtml = "";
        if (item.incompatible) {
            item.incompatible.forEach(badId => {
                if (state.selected.has(badId)) {
                    reqsHtml += `<span class="req-item fail">‚ùå Incompatible with: ${getItemTitle(badId)}</span>`;
                }
            });
        }
        const isSelected = state.selected.has(item.id);
        if (!isSelected && group.rules && group.rules.max_choices) {
            const currentCount = group.items.filter(i => state.selected.has(i.id)).length;
            if (currentCount >= group.rules.max_choices) {
                reqsHtml += `<span class="req-item fail">‚õî Max limit reached (${group.rules.max_choices})</span>`;
            }
        }
        if (item.requirements) {
            item.requirements.forEach(req => {
                 let isMet = false;
                 let displayText = req;
                 if (req.includes('(') || req.includes('||') || req.includes('&&')) {
                     isMet = runEval(req);
                     displayText = displayText.replace(/has\(['"](.+?)['"]\)/g, (match, id) => getItemTitle(id));
                     displayText = displayText.replace(/\|\|/g, " <b style='color:#fff'>OR</b> ").replace(/&&/g, " AND ");
                 } else {
                    const isNot = req.startsWith('!');
                    const cleanId = isNot ? req.slice(1) : req;
                    isMet = isNot ? !state.selected.has(cleanId) : state.selected.has(cleanId);
                    displayText = (isNot ? "NOT " : "") + getItemTitle(cleanId);
                 }
                 if (!isMet) reqsHtml += `<span class="req-item missing">‚ö†Ô∏è Requires: ${displayText}</span>`;
                 else reqsHtml += `<span class="req-item ok">‚úî ${displayText}</span>`;
            });
        }

        if (reqsHtml) html += `<div class="reqs">${reqsHtml}</div>`;
        if (isDebug) html += `<div class="debug-info">ID: ${item.id}</div>`;
        
        // –í —Ç—É–ª—Ç–∏–ø–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ,
        // –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
        if (!document.body.classList.contains('text-mode') && item.description) {
            html += `<div class="desc" style="display:block; margin-top:10px; border-top:1px solid #333; padding-top:5px;">${item.description}</div>`;
        }

        tt.innerHTML = html;
    }
    
    function updateTooltipPosition(e) {
        const tt = document.getElementById('tooltip');
        const ttH = tt.offsetHeight, ttW = tt.offsetWidth;
        let top = e.clientY + 20, left = e.clientX + 20;
        if (left + ttW > window.innerWidth) left = window.innerWidth - ttW - 20;
        if (top + ttH > window.innerHeight) top = e.clientY - ttH - 10;
        tt.style.top = top + 'px'; tt.style.left = left + 'px';
    }

    init();
</script>

</body>
</html>