
============================================================
FILE START: generate_test_image.html
============================================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Generator</title>
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
        }
        
        h1 { color: #4CAF50; }
        
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #333;
            border-radius: 8px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        canvas {
            border: 2px solid #555;
            display: block;
            margin: 20px 0;
            max-width: 100%;
            background: white;
        }
        
        .info {
            background: #444;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        code {
            background: #555;
            padding: 2px 6px;
            border-radius: 3px;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üé® Test Image Generator</h1>
    
    <div class="info">
        <strong>Instructions:</strong>
        <ol>
            <li>Click "Generate Test Image" below</li>
            <li>Right-click the image ‚Üí "Save image as..."</li>
            <li>Save to <code>config/test_image.png</code></li>
            <li>Run <code>index.html</code> to see it in action!</li>
        </ol>
    </div>
    
    <div class="controls">
        <button onclick="generateImage()">üé® Generate Test Image</button>
        <button onclick="downloadImage()">üíæ Download Image</button>
    </div>
    
    <canvas id="canvas" width="1920" height="1080"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function generateImage() {
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Title
            ctx.fillStyle = '#eee';
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Test CYOA - Rule Examples', canvas.width / 2, 120);

            // Groups with boxes
            const groups = [
                { title: 'Free Items', y: 220, items: 3, color: '#4CAF50' },
                { title: 'Paid Items', y: 440, items: 3, color: '#FF9800' },
                { title: 'Requirements', y: 660, items: 3, color: '#2196F3' },
                { title: 'Incompatible', y: 880, items: 2, color: '#F44336' }
            ];

            groups.forEach(group => {
                // Group background
                ctx.fillStyle = 'rgba(255,255,255,0.05)';
                ctx.fillRect(50, group.y, 1240, 200);

                // Group title
                ctx.fillStyle = group.color;
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(group.title, 70, group.y + 30);

                // Item boxes
                for (let i = 0; i < group.items; i++) {
                    const x = 50 + i * 420;
                    const y = group.y + 30;

                    // Box
                    ctx.strokeStyle = group.color;
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x, y, 400, 150);

                    // Item title
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Item ${i + 1}`, x + 200, y + 80);
                }
            });

            // Right column - Choose 1
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            ctx.fillRect(1310, 220, 560, 640);
            
            ctx.fillStyle = '#9C27B0';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Choose Only 1', 1330, 250);

            for (let i = 0; i < 3; i++) {
                const y = 220 + 30 + i * 170;
                ctx.strokeStyle = '#9C27B0';
                ctx.lineWidth = 3;
                ctx.strokeRect(1330, y, 520, 150);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Choice ${String.fromCharCode(65 + i)}`, 1590, y + 80);
            }

            // Budget group
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            ctx.fillRect(1310, 880, 560, 200);
            
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Budget: 5 Free Picks', 1330, 910);

            for (let i = 0; i < 2; i++) {
                const x = 1330 + i * 270;
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                ctx.strokeRect(x, 910, 250, 150);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Budget ${i + 1}`, x + 125, 990);
            }

            // Footer
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Generated Test Image - Click items to select them!', canvas.width / 2, canvas.height - 30);

            console.log('‚úÖ Image generated!');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'test_image.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            console.log('üíæ Download started!');
        }

        // Auto-generate on load
        window.onload = () => {
            generateImage();
        };
    </script>
</body>
</html>


============================================================
FILE START: index.html
============================================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYOA Interactive Player</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app">
        <!-- Top controls -->
        <div class="top-controls">
            <button id="text-toggle" class="ctrl-btn">üìñ Translation</button>
            <button id="edit-toggle" class="ctrl-btn">‚úèÔ∏è Edit</button>
            <button id="reset-btn" class="ctrl-btn">üîÑ Reset</button>
        </div>
        
        <!-- Game content -->
        <div id="game-wrapper"></div>
        
        <!-- Points bar -->
        <div id="points-bar"></div>
        
        <!-- Tooltip -->
        <div id="tooltip"></div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" style="
        position: fixed; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: #fff;
        text-align: center;
    ">
        Loading CYOA...<br>
        <small style="color: #888; font-size: 14px;">
            Check console (F12) if this takes too long
        </small>
    </div>

    <script type="module" src="src/main.js"></script>
</body>
</html>


============================================================
FILE START: readme
============================================================

cyoa-interactive/
‚îú‚îÄ‚îÄ index.html                 # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π loader
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îú‚îÄ‚îÄ main.css              # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ themes.css            # –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine.js         # –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ state.js          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rules.js          # –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ renderer.js       # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tooltip.js        # –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ controls.js       # –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ coords.js         # –†–∞–±–æ—Ç–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
‚îÇ       ‚îî‚îÄ‚îÄ evaluator.js      # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π eval
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ schema.json           # JSON Schema –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ example.json          # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ llm-guide.md          # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è LLM
    ‚îî‚îÄ‚îÄ rule-catalog.md       # –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–∞–≤–∏–ª




    # CYOA Interactive System - Quick Start Guide

–°–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã.

## üéØ –ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç?

1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É CYOA
2. –†–∏—Å—É–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
3. –°—á–∏—Ç–∞–µ—Ç –æ—á–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
cyoa-interactive/
‚îú‚îÄ‚îÄ README.md                  ‚Üê –≤—ã –∑–¥–µ—Å—å
‚îú‚îÄ‚îÄ index.html                 ‚Üê –ó–ê–ü–£–°–ö–ê–¢–¨ –≠–¢–û–¢ –§–ê–ô–õ
‚îú‚îÄ‚îÄ generate_test_image.html   ‚Üê –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ main.css
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.js
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ state.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rules.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ renderer.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tooltip.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ controls.js
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ coords.js
‚îî‚îÄ‚îÄ config/
    ‚îú‚îÄ‚îÄ test_config.json       ‚Üê —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ‚îî‚îÄ‚îÄ test_image.png         ‚Üê —Ç–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞

```

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å (3 —Å–ø–æ—Å–æ–±–∞)

### –°–ø–æ—Å–æ–± 1: –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

ES6 –º–æ–¥—É–ª–∏ —Ç—Ä–µ–±—É—é—Ç HTTP —Å–µ—Ä–≤–µ—Ä. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

#### Python (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):
```bash
# Python 3
python -m http.server 8000

# Python 2
python -m SimpleHTTPServer 8000
```

#### Node.js (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):
```bash
npx http-server -p 8000
```

#### VS Code:
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ "Live Server" –∏ –Ω–∞–∂–º–∏—Ç–µ "Go Live"

–ó–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ: **http://localhost:8000**

---

### –°–ø–æ—Å–æ–± 2: –ë–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ (Firefox)

Firefox —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –º–æ–¥—É–ª–∏ —Å `file://`:

1. –û—Ç–∫—Ä–æ–π—Ç–µ Firefox
2. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ `index.html` –≤ –æ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞
3. ‚úÖ –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!

---

### –°–ø–æ—Å–æ–± 3: Chrome —Å —Ñ–ª–∞–≥–æ–º (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
chrome.exe --allow-file-access-from-files
```

‚ö†Ô∏è –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!

---

## üìù –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ `generate_test_image.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ù–∞–∂–º–∏—Ç–µ "Generate Test Image"
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ `config/test_image.png`

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –í—Ä—É—á–Ω—É—é

–°–æ–∑–¥–∞–π—Ç–µ –ª—é–±—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É 1920x1080px —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–æ–Ω–∞–º–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫.
–ú–æ–∂–Ω–æ –≤ Paint, Photoshop, –∏–ª–∏ –æ–Ω–ª–∞–π–Ω –Ω–∞ https://pixlr.com

---

## üéÆ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

| –ö–Ω–æ–ø–∫–∞ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|--------|------------|
| üìñ Translation | –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ (–¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤) |
| üêû Debug | –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ—Ö –∑–æ–Ω |
| üîÑ Reset | –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ |

–í–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ - –ø–∞–Ω–µ–ª—å —Å –æ—á–∫–∞–º–∏.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ß—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –ø—Ä–∏–º–µ—Ä–µ:

‚úÖ –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –≤—ã–¥–µ–ª—è–µ—Ç –µ—ë –∑–µ–ª—ë–Ω—ã–º  
‚úÖ –û—á–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  
‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω—É–∂–Ω—ã—Ö  
‚úÖ –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è  
‚úÖ –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∞  
‚úÖ "Choose 1" –≥—Ä—É–ø–ø–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∞  

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥–∞

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–∏–º–µ—Ä:

```json
{
  "meta": {
    "title": "Test CYOA",
    "pages": ["config/test_image.png"]
  },
  "points": [
    {
      "id": "points",
      "name": "Points",
      "start": 10
    }
  ],
  "groups": [
    {
      "id": "test_group",
      "title": "Test Group",
      "page": 0,
      "items": [
        {
          "id": "item1",
          "title": "Free Item",
          "coords": {"x": 100, "y": 100, "w": 300, "h": 200},
          "description": "This item is free!",
          "cost": []
        },
        {
          "id": "item2",
          "title": "Costs 5 Points",
          "coords": {"x": 450, "y": 100, "w": 300, "h": 200},
          "description": "This costs 5 points",
          "cost": [{"currency": "points", "value": -5}]
        }
      ]
    }
  ]
}
```

---

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### "Failed to load module" –æ—à–∏–±–∫–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç ES6 –º–æ–¥—É–ª–∏ —Å `file://`

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (—Å–º. –≤—ã—à–µ)

---

### –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –ü—É—Ç—å –≤ `config.json` ‚Üí `"pages": ["config/test_image.png"]`
2. –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø–∞–ø–∫–µ `config/`
3. –ò–º—è —Ñ–∞–π–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (—Ä–µ–≥–∏—Å—Ç—Ä –≤–∞–∂–µ–Ω!)

**–û—Ç–ª–∞–¥–∫–∞:**
–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏

---

### –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç

**–û—Ç–∫—Ä–æ–π—Ç–µ Debug Mode** (–∫–Ω–æ–ø–∫–∞ üêû):
- –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∫—Ä–∞—Å–Ω—ã–µ —Ä–∞–º–∫–∏ –≤–æ–∫—Ä—É–≥ –∑–æ–Ω
- –ï—Å–ª–∏ —Ä–∞–º–æ–∫ –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:**
```json
{
  "coords": {
    "x": 100,    // –æ—Ç 0 –¥–æ —à–∏—Ä–∏–Ω—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏
    "y": 100,    // –æ—Ç 0 –¥–æ –≤—ã—Å–æ—Ç—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏  
    "w": 300,    // —à–∏—Ä–∏–Ω–∞ –∑–æ–Ω—ã
    "h": 200     // –≤—ã—Å–æ—Ç–∞ –∑–æ–Ω—ã
  }
}
```

---

### –û—á–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞–∫ `value`:**
- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ = —Ç—Ä–∞—Ç–∞: `"value": -5`
- –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ = –ø–æ–ª—É—á–µ–Ω–∏–µ: `"value": 5`
- –ù–æ–ª—å = –±–µ—Å–ø–ª–∞—Ç–Ω–æ: `"value": 0`

**–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)** –∏ –∏—â–∏—Ç–µ –æ—à–∏–±–∫–∏

---

## üìñ –î–∞–ª—å–Ω–µ–π—à–µ–µ –∏–∑—É—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞:

1. **–ò–∑—É—á–∏—Ç–µ** `docs/rule-catalog.md` - –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
2. **–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ** `config/test_config.json` - –ø—Ä–∏–º–µ—Ä—ã –≤—Å–µ—Ö –º–µ—Ö–∞–Ω–∏–∫
3. **–ò–∑–º–µ–Ω–∏—Ç–µ** –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫ –¥–≤–∏–≥–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏
4. **–î–æ–±–∞–≤—å—Ç–µ** —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥

---

## üÜò –ü–æ–º–æ—â—å

**–ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)** - –≤–∞—à –ª—É—á—à–∏–π –¥—Ä—É–≥!

–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Å–æ–ª–∏:
```javascript
// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
CYOA.engine.state

// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ñ–∏–≥
CYOA.engine.config

// –í—ã–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
CYOA.engine.select('item_id')

// –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
CYOA.engine.reset()
```

---

## ‚ú® –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
2. ‚úÖ –ü–æ–Ω—è—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
3. ‚úÖ –ò–∑—É—á–∏—Ç—å config —Å—Ç—Ä—É–∫—Ç—É—Ä—É
4. üìö –ü—Ä–æ—á–∏—Ç–∞—Ç—å `docs/rule-catalog.md`
5. üé® –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –ø–µ—Ä–≤—É—é CYOA
6. ü§ñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

---

**–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É! üöÄ**

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –∏ –∏—â–∏—Ç–µ –∫—Ä–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –æ—à–∏–±–∫–∞–º–∏.


============================================================
FILE START: config\example.json
============================================================




============================================================
FILE START: config\schema.json
============================================================




============================================================
FILE START: config\test_config.json
============================================================

{
  "meta": {
    "title": "Test CYOA - Rule Examples",
    "author": "System Test",
    "version": "1.0",
    "pages": [
      "config/test_image.png"
    ]
  },
  "points": [
    {
      "id": "points",
      "name": "Points",
      "start": 10
    },
    {
      "id": "gold",
      "name": "Gold",
      "start": 100
    }
  ],
  "groups": [
    {
      "id": "intro",
      "title": "Introduction",
      "description": "Welcome to the test CYOA!\n\nThis demonstrates all available mechanics:\n- Simple costs\n- Requirements\n- Incompatibilities\n- Max choices\n- Budgets\n- Formulas",
      "page": 0,
      "coords": {
        "x": 50,
        "y": 50,
        "w": 1820,
        "h": 150
      },
      "items": []
    },
    {
      "id": "free_items",
      "title": "Free Items",
      "description": "These items cost nothing. Click to select!",
      "page": 0,
      "coords": {
        "x": 50,
        "y": 220,
        "w": 1820,
        "h": 200
      },
      "items": [
        {
          "id": "free1",
          "title": "Free Item 1",
          "description": "This item is completely free.\nNo requirements, no costs.",
          "coords": {
            "x": 50,
            "y": 250,
            "w": 400,
            "h": 150
          },
          "cost": []
        },
        {
          "id": "free2",
          "title": "Free Item 2",
          "description": "Another free item.\nYou can select both!",
          "coords": {
            "x": 470,
            "y": 250,
            "w": 400,
            "h": 150
          },
          "cost": []
        },
        {
          "id": "bonus",
          "title": "Bonus Points",
          "description": "This actually GIVES you points!\nPositive cost = gain.",
          "coords": {
            "x": 890,
            "y": 250,
            "w": 400,
            "h": 150
          },
          "cost": [
            {
              "currency": "points",
              "value": 5
            }
          ]
        }
      ]
    },
    {
      "id": "paid_items",
      "title": "Paid Items",
      "description": "These cost points. Watch the counter at the bottom!",
      "page": 0,
      "coords": {
        "x": 50,
        "y": 440,
        "w": 1820,
        "h": 200
      },
      "items": [
        {
          "id": "cheap",
          "title": "Cheap Item",
          "description": "Costs only 2 points.\nAffordable for everyone!",
          "coords": {
            "x": 50,
            "y": 470,
            "w": 400,
            "h": 150
          },
          "cost": [
            {
              "currency": "points",
              "value": -2
            }
          ]
        },
        {
          "id": "expensive",
          "title": "Expensive Item",
          "description": "Costs 8 points.\nChoose wisely!",
          "coords": {
            "x": 470,
            "y": 470,
            "w": 400,
            "h": 150
          },
          "cost": [
            {
              "currency": "points",
              "value": -8
            }
          ]
        },
        {
          "id": "dual_cost",
          "title": "Dual Cost",
          "description": "Costs both points AND gold.\nMultiple currencies!",
          "coords": {
            "x": 890,
            "y": 470,
            "w": 400,
            "h": 150
          },
          "cost": [
            {
              "currency": "points",
              "value": -3
            },
            {
              "currency": "gold",
              "value": -25
            }
          ]
        }
      ]
    },
    {
      "id": "requirements",
      "title": "Items with Requirements",
      "description": "These require other items first.",
      "page": 0,
      "coords": {
        "x": 50,
        "y": 660,
        "w": 1820,
        "h": 200
      },
      "items": [
        {
          "id": "requires_free1",
          "title": "Requires Free 1",
          "description": "You must select 'Free Item 1' first.\n\nTry it: select Free Item 1, then this becomes available.",
          "coords": {
            "x": 50,
            "y": 690,
            "w": 400,
            "h": 150
          },
          "cost": [],
          "requirements": ["free1"]
        },
        {
          "id": "requires_any",
          "title": "Requires Any Free",
          "description": "Requires Free Item 1 OR Free Item 2.\n\nFormula: free1 || free2",
          "coords": {
            "x": 470,
            "y": 690,
            "w": 400,
            "h": 150
          },
          "cost": [],
          "requirements": ["has('free1') || has('free2')"]
        },
        {
          "id": "requires_both",
          "title": "Requires Both",
          "description": "Requires BOTH Cheap AND Expensive items.\n\nFormula: cheap && expensive",
          "coords": {
            "x": 890,
            "y": 690,
            "w": 400,
            "h": 150
          },
          "cost": [],
          "requirements": ["has('cheap') && has('expensive')"]
        }
      ]
    },
    {
      "id": "incompatible",
      "title": "Incompatible Items",
      "description": "These cannot be selected together.",
      "page": 0,
      "coords": {
        "x": 50,
        "y": 880,
        "w": 1820,
        "h": 200
      },
      "items": [
        {
          "id": "fire",
          "title": "Fire Magic",
          "description": "Incompatible with Ice Magic.\nChoose your element!",
          "coords": {
            "x": 50,
            "y": 910,
            "w": 400,
            "h": 150
          },
          "cost": [{"currency": "points", "value": -3}],
          "incompatible": ["ice"]
        },
        {
          "id": "ice",
          "title": "Ice Magic",
          "description": "Incompatible with Fire Magic.\nOpposite elements!",
          "coords": {
            "x": 470,
            "y": 910,
            "w": 400,
            "h": 150
          },
          "cost": [{"currency": "points", "value": -3}],
          "incompatible": ["fire"]
        }
      ]
    },
    {
      "id": "max_choices",
      "title": "Choose Only 1",
      "description": "Radio button behavior - only one allowed.",
      "page": 0,
      "coords": {
        "x": 1310,
        "y": 220,
        "w": 560,
        "h": 640
      },
      "rules": {
        "max_choices": 1
      },
      "items": [
        {
          "id": "choice_a",
          "title": "Choice A",
          "description": "Selecting this deselects B and C.",
          "coords": {
            "x": 1330,
            "y": 250,
            "w": 520,
            "h": 150
          },
          "cost": []
        },
        {
          "id": "choice_b",
          "title": "Choice B",
          "description": "Selecting this deselects A and C.",
          "coords": {
            "x": 1330,
            "y": 420,
            "w": 520,
            "h": 150
          },
          "cost": []
        },
        {
          "id": "choice_c",
          "title": "Choice C",
          "description": "Selecting this deselects A and B.",
          "coords": {
            "x": 1330,
            "y": 590,
            "w": 520,
            "h": 150
          },
          "cost": []
        }
      ]
    },
    {
      "id": "budget_group",
      "title": "Budget Example",
      "description": "This group has 5 free picks!\nAfter 5, items cost points.",
      "page": 0,
      "coords": {
        "x": 1310,
        "y": 880,
        "w": 560,
        "h": 200
      },
      "rules": {
        "budget": {
          "currency": "points",
          "amount": 5,
          "name": "Free Picks"
        }
      },
      "items": [
        {
          "id": "budget1",
          "title": "Budget Item 1",
          "description": "Normally costs 2 points.\nFree if budget available!",
          "coords": {
            "x": 1330,
            "y": 910,
            "w": 250,
            "h": 150
          },
          "cost": [{"currency": "points", "value": -2}]
        },
        {
          "id": "budget2",
          "title": "Budget Item 2",
          "description": "Also costs 2 points.\nCovered by budget!",
          "coords": {
            "x": 1600,
            "y": 910,
            "w": 250,
            "h": 150
          },
          "cost": [{"currency": "points", "value": -2}]
        }
      ]
    }
  ]
}


============================================================
FILE START: docs\llm-guide.md
============================================================

# LLM Guide: CYOA Extraction

## Your Task
Extract game structure from CYOA images into JSON configuration.

## Output Format

```json
{
  "meta": {
    "title": "Game Title",
    "pages": ["page1.png", "page2.png"]
  },
  "points": [
    {
      "id": "points",
      "name": "Points",
      "start": 10
    }
  ],
  "groups": [
    {
      "id": "group_id",
      "title": "Group Title",
      "description": "...",
      "page": 0,
      "coords": {"x": 10, "y": 20, "w": 30, "h": 40},
      "rules": {
        "max_choices": 3,
        "budget": {
          "currency": "points",
          "amount": 5,
          "name": "Free Picks"
        }
      },
      "items": [...]
    }
  ]
}
```

## Item Structure

```json
{
  "id": "unique_id",
  "title": "Item Name",
  "description": "Full text",
  "coords": {"x": 100, "y": 200, "w": 300, "h": 400},
  "cost": [
    {
      "currency": "points",
      "value": -5,
      "formula": "count.this_group > 2 ? -2 : 0"
    }
  ],
  "requirements": [
    "other_item_id",
    "item_a || item_b",
    "count.companions >= 3"
  ],
  "incompatible": ["opposite_item"]
}
```

## Pattern Recognition

| Image Text | JSON Rule |
|------------|-----------|
| "Costs 5 points" | `"cost": [{"currency": "points", "value": -5}]` |
| "+10 gold" | `"cost": [{"currency": "gold", "value": 10}]` |
| "Requires: Magic" | `"requirements": ["magic"]` |
| "Choose up to 3" | `"rules": {"max_choices": 3}` |
| "3 free picks" | `"rules": {"budget": {"currency": "points", "amount": 3}}` |
| "Incompatible with Fire" | `"incompatible": ["fire"]` |

## Coordinate System

Use **pixels from top-left** corner:
```json
{
  "x": 100,    // left edge
  "y": 200,    // top edge  
  "w": 300,    // width
  "h": 400     // height
}
```

System auto-converts to percentages.

## Common Mistakes

‚ùå **Wrong:**
```json
{
  "cost": [{"currency": "points", "value": 5}]  // Positive = gain!
}
```

‚úÖ **Correct:**
```json
{
  "cost": [{"currency": "points", "value": -5}]  // Negative = spend
}
```

---

‚ùå **Wrong:**
```json
{
  "requirements": ["item_a AND item_b"]  // Wrong syntax
}
```

‚úÖ **Correct:**
```json
{
  "requirements": ["item_a && item_b"]  // Use &&
}
```


============================================================
FILE START: docs\rule-catalog.md
============================================================

### `docs/rule-catalog.md`

# CYOA Rule Catalog for LLM

## Overview
This catalog defines all available game mechanics that can be extracted from CYOA images.
Each rule is declarative and composable.

---

## ü™ô Currency System

### Basic Currency
```json
{
  "points": [
    {
      "id": "points",           // unique identifier
      "name": "Points",          // display name
      "start": 100,              // starting amount
      "min": 0,                  // optional minimum (default: -Infinity)
      "max": null                // optional maximum
    }
  ]
}
```

**Examples from images:**
- "You have 10 points to spend"
- "Starting credits: 50"
- "Budget: 7 Sparks of Power"

---

## üí∞ Cost Rules

### Rule: `simple_cost`
Item costs a fixed amount.

```json
{
  "cost": [
    {
      "currency": "points",
      "value": -5              // negative = spend, positive = gain
    }
  ]
}
```

**Pattern recognition:**
- "Costs 5 points"
- "-3 gold"
- "Price: 2 sparks"

---

### Rule: `conditional_cost`
Cost changes based on conditions.

```json
{
  "cost": [
    {
      "currency": "points",
      "base": -5,
      "formula": "selected.length > 3 ? -2 : 0"
    }
  ]
}
```

**Examples:**
- "Costs 5 points, +2 if you have more than 3 perks"
- "First pick free, then 3 points each"

**Formula syntax:**
```javascript
// Available variables:
selected.length        // number of selected items in this group
selected.has("id")     // check if item is selected
currency.points        // current currency value
count.groupId          // items selected in specific group

// Examples:
"count.companions > 2 ? -5 : -3"
"selected.length * -2"
"currency.points < 10 ? -1 : -3"
```

---

## üîí Requirement Rules

### Rule: `requires_item`
Requires another item to be selected.

```json
{
  "requirements": ["item_id"]
}
```

**Patterns:**
- "Requires: Magic Affinity"
- "Must have: Dragon Bond"
- "Prerequisite: Arcane Knowledge"

---

### Rule: `requires_any`
Requires at least one from a list.

```json
{
  "requirements": [
    "item_a || item_b || item_c"
  ]
}
```

**Patterns:**
- "Requires one of: Fire, Ice, Lightning"
- "Must have at least one combat ability"

---

### Rule: `requires_all`
Requires all items from a list.

```json
{
  "requirements": [
    "item_a && item_b"
  ]
}
```

**Patterns:**
- "Requires both: Sword Mastery AND Shield Training"

---

### Rule: `requires_count`
Requires a certain number of items from a group.

```json
{
  "requirements": [
    "count.perks >= 3"
  ]
}
```

**Patterns:**
- "Available after selecting 3 perks"
- "Unlock at 5+ companions"

---

### Rule: `incompatible`
Cannot be selected together.

```json
{
  "incompatible": ["item_id"]
}
```

**Patterns:**
- "Incompatible with: X"
- "Cannot take with: Y"
- "Mutually exclusive"

---

## üìä Group Rules

### Rule: `max_choices`
Limit selections in a group.

```json
{
  "rules": {
    "max_choices": 3,
    "min_choices": 1          // optional
  }
}
```

**Patterns:**
- "Choose up to 3"
- "Pick 1-3 options"
- "Select exactly 2"

---

### Rule: `pick_style`
How selections work.

```json
{
  "rules": {
    "pick_style": "radio"     // only one at a time
    // or
    "pick_style": "checkbox"  // multiple allowed (default)
  }
}
```

---

### Rule: `local_budget`
Group has its own point pool.

```json
{
  "rules": {
    "budget": {
      "currency": "points",
      "amount": 10,
      "name": "Perk Budget",
      "applies_to": ["group_a", "group_b"]  // optional: share budget
    }
  }
}
```

**Patterns:**
- "This section has 5 free picks"
- "10 point budget for powers"
- "Shared pool: 8 choices across items and companions"

---

### Rule: `free_first_n`
First N selections are free.

```json
{
  "rules": {
    "free_first": 2
  }
}
```

**Patterns:**
- "First 2 picks free"
- "One free choice included"

Formula equivalent:
```json
{
  "cost": [{
    "currency": "points",
    "base": -3,
    "formula": "count.this_group < 2 ? 3 : 0"
  }]
}
```

---

## üé≤ Advanced Rules

### Rule: `scaling_cost`
Cost increases with selections.

```json
{
  "cost": [{
    "currency": "points",
    "formula": "-(2 ** count.this_group)"  // 2, 4, 8, 16...
  }]
}
```

**Patterns:**
- "Each additional costs double"
- "1st: 1 point, 2nd: 2 points, 3rd: 4 points..."

---

### Rule: `discount`
Reduce cost based on conditions.

```json
{
  "cost": [{
    "currency": "points",
    "base": -10,
    "formula": "selected.has('merchant_perk') ? 5 : 0"
  }]
}
```

**Patterns:**
- "50% off if you have Merchant"
- "Free with Noble background"

---

### Rule: `toggle_effect`
Selecting changes other items.

```json
{
  "effects": [
    {
      "type": "modify_currency",
      "currency": "mana",
      "value": 100
    },
    {
      "type": "unlock_item",
      "target": "secret_path"
    }
  ]
}
```

---

## üîÑ Dynamic Rules (Custom JS)

For unique mechanics not covered above:

```json
{
  "custom_rule": {
    "type": "javascript",
    "code": "return selected.has('dragon') && currency.gold >= 1000;"
  }
}
```

**Use sparingly!** Try to compose existing rules first.

---

## üìù LLM Extraction Instructions

When analyzing a CYOA image:

1. **Identify currencies:**
   - Look for: "points", "budget", "credits", "gold"
   - Extract starting amounts

2. **Identify groups:**
   - Usually separated by headers or visual sections
   - Extract title and description

3. **For each item/card:**
   - Extract: title, description, position
   - Look for cost indicators (-, Cost:, Price:)
   - Find requirements (Requires:, Needs:, Must have:)
   - Check for incompatibilities (Incompatible:, Cannot:)

4. **For group rules:**
   - "Choose X" ‚Üí `max_choices`
   - "Pick up to X" ‚Üí `max_choices`
   - "X free picks" ‚Üí `budget` or `free_first`

5. **Output format:**
   ```json
   {
     "item_id": {
       "title": "...",
       "cost": [...],
       "requirements": [...],
       "incompatible": [...]
     }
   }
   ```

---

## ‚ö†Ô∏è Common Patterns

| Text Pattern | Rule | JSON |
|--------------|------|------|
| "Costs 5 points" | simple_cost | `"cost": [{"currency": "points", "value": -5}]` |
| "Requires: Fire Magic" | requires_item | `"requirements": ["fire_magic"]` |
| "Choose 3" | max_choices | `"rules": {"max_choices": 3}` |
| "Incompatible with Ice" | incompatible | `"incompatible": ["ice_magic"]` |
| "First pick free" | free_first | `"rules": {"free_first": 1}` |
| "+10 mana" | gain_currency | `"cost": [{"currency": "mana", "value": 10}]` |

---

## üß™ Validation

Always ensure:
- [ ] All referenced IDs exist
- [ ] Costs are negative for spending
- [ ] Requirements don't create impossible loops
- [ ] Formulas are valid JavaScript
- [ ] Coordinates are within image bounds

 


============================================================
FILE START: src\main.js
============================================================

/**
 * CYOA Interactive System - Main Entry Point
 * 
 * This file initializes the entire system:
 * 1. Loads config from JSON
 * 2. Creates game engine
 * 3. Creates UI renderer
 * 4. Sets up controls
 */
 

import { GameEngine } from './core/engine.js';
import { UIRenderer } from './ui/renderer.js';
import { ControlPanel } from './ui/controls.js';

// Global state
let engine, renderer, controls;

async function init() {
    console.log('üöÄ Starting CYOA Interactive System...');
    
    try {
        const response = await fetch('config/test_config.json');
        
        if (!response.ok) {
            throw new Error(`Config not found (${response.status})`);
        }
        
        const config = await response.json();
        console.log('‚úÖ Config loaded:', config.meta?.title || 'Untitled');

        engine = new GameEngine(config);
        renderer = new UIRenderer(engine);
        controls = new ControlPanel(engine, renderer);

        await renderer.renderAll();
         
        engine.recalculate();

        const loading = document.getElementById('loading');
        if (loading) {
            loading.classList.add('hidden');
            setTimeout(() => loading.remove(), 300);
        }

        console.log('‚ú® CYOA loaded successfully!');
        console.log('üí° Tip: Click üêû Debug to enter edit mode');

    } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        
        const loading = document.getElementById('loading');
        if (loading) {
            loading.innerHTML = `
                <div style="color: #ff4444;">
                    ‚ùå Failed to load CYOA<br>
                    <small>${error.message}</small><br><br>
                    <small style="color: #888;">
                        Check console (F12) for details<br>
                        Make sure you're running via HTTP server
                    </small>
                </div>
            `;
        }
    }
}

init();

// Export for debugging via browser console
window.CYOA = {
    get engine() { return engine; },
    get renderer() { return renderer; },
    get controls() { return controls; },
    get editor() { return controls?.editor; },
    get state() { return engine?.state; },
    get config() { return engine?.config; }
};

console.log('üí° Debug commands available:');
console.log('  CYOA.engine.select("item_id")  - Select an item');
console.log('  CYOA.engine.reset()            - Reset everything');
console.log('  CYOA.editor.enable()           - Enable editor');
console.log('  CYOA.state                     - View current state');


============================================================
FILE START: src\core\engine.js
============================================================

/**
 * Game Engine - Core game logic and state management
 */

import { RuleEvaluator } from './rules.js';
import { GameState } from './state.js';

export class GameEngine {
    constructor(config) {
        this.config = config;
        this.state = new GameState(config);
        this.rules = new RuleEvaluator(this);
        this.listeners = {};
        
        console.log('üéÆ Engine initialized');
    }

    // ==================== SELECTION ====================

    /**
     * Select an item
     * @param {string} itemId - Item ID to select
     * @returns {boolean} Success
     */
    select(itemId) {
        const item = this.findItem(itemId);
        if (!item) {
            console.warn(`Item not found: ${itemId}`);
            return false;
        }

        const group = this.findGroupForItem(itemId);
        if (!group) {
            console.warn(`Group not found for: ${itemId}`);
            return false;
        }

        // Check if can select
        if (!this.canSelect(item, group)) {
            console.log(`Cannot select ${itemId} (requirements not met)`);
            return false;
        }

        // Handle max_choices (radio button behavior)
        if (group.rules?.max_choices === 1) {
            group.items.forEach(i => {
                if (this.state.selected.has(i.id)) {
                    this.state.selected.delete(i.id);
                }
            });
        } else if (group.rules?.max_choices) {
            const selectedInGroup = this.getSelectedInGroup(group);
            if (selectedInGroup.length >= group.rules.max_choices) {
                console.log(`Max choices reached in ${group.id}`);
                return false;
            }
        }

        this.state.selected.add(itemId);
        this.recalculate();
        this.emit('selection', { itemId, selected: true });
        
        console.log(`‚úì Selected: ${item.title}`);
        return true;
    }

    /**
     * Deselect an item
     */
    deselect(itemId) {
        if (!this.state.selected.has(itemId)) {
            return false;
        }

        this.state.selected.delete(itemId);
        this.recalculate();
        this.emit('selection', { itemId, selected: false });
        
        const item = this.findItem(itemId);
        console.log(`‚úó Deselected: ${item?.title || itemId}`);
        return true;
    }

    /**
     * Toggle item selection
     */
    toggle(itemId) {
        if (this.state.selected.has(itemId)) {
            return this.deselect(itemId);
        } else {
            return this.select(itemId);
        }
    }

    // ==================== VALIDATION ====================

    /**
     * Check if item can be selected
     */
    canSelect(item, group) {
        if (!this.rules.checkRequirements(item)) {
            return false;
        }

        if (!this.rules.checkIncompatible(item)) {
            return false;
        }

        return true;
    }

    // ==================== CALCULATION ====================

    /**
     * Recalculate all costs and currencies
     */
    recalculate() {
        // 1. Remove invalid selections
        this.cleanupInvalidSelections();

        // 2. Reset currencies
        this.state.resetCurrencies();

        // 3. Calculate with budgets
        const groupDeltas = this.calculateGroupDeltas();
        this.applyBudgets(groupDeltas);
        this.applyDeltas(groupDeltas);

        // 4. Notify listeners
        this.emit('recalculate', { state: this.state });
    }

    /**
     * Remove selections that no longer meet requirements
     */
    cleanupInvalidSelections() {
        let changed = true;
        let iterations = 0;
        const MAX_ITERATIONS = 100;

        while (changed && iterations < MAX_ITERATIONS) {
            changed = false;
            iterations++;

            for (const itemId of Array.from(this.state.selected)) {
                const item = this.findItem(itemId);
                const group = this.findGroupForItem(itemId);

                if (!item || !this.canSelect(item, group)) {
                    this.state.selected.delete(itemId);
                    changed = true;
                }
            }
        }

        if (iterations >= MAX_ITERATIONS) {
            console.warn('‚ö†Ô∏è Dependency cleanup hit max iterations');
        }
    }

    /**
     * Calculate currency deltas per group
     */
    calculateGroupDeltas() {
        const deltas = {};

        for (const itemId of this.state.selected) {
            const item = this.findItem(itemId);
            const group = this.findGroupForItem(itemId);
            
            if (!item?.cost) continue;

            if (!deltas[group.id]) {
                deltas[group.id] = {};
            }

            for (const cost of item.cost) {
                const value = this.rules.evaluateCost(cost, item, group);
                const currencyId = cost.currency;

                if (!deltas[group.id][currencyId]) {
                    deltas[group.id][currencyId] = 0;
                }

                deltas[group.id][currencyId] += value;
            }
        }

        return deltas;
    }

    /**
     * Apply budget rules to deltas
     */
    applyBudgets(groupDeltas) {
        for (const group of this.config.groups) {
            if (!group.rules?.budget) continue;

            const budget = group.rules.budget;
            const targetGroups = [group.id, ...(budget.applies_to || [])];

            // Calculate total spent
            let totalSpent = 0;
            for (const gid of targetGroups) {
                if (groupDeltas[gid]?.[budget.currency] < 0) {
                    totalSpent += Math.abs(groupDeltas[gid][budget.currency]);
                }
            }

            // Apply coverage
            const covered = Math.min(totalSpent, budget.amount);
            let remaining = covered;

            for (const gid of targetGroups) {
                if (remaining <= 0) break;
                
                if (groupDeltas[gid]?.[budget.currency] < 0) {
                    const debt = Math.abs(groupDeltas[gid][budget.currency]);
                    const pay = Math.min(debt, remaining);
                    groupDeltas[gid][budget.currency] += pay;
                    remaining -= pay;
                }
            }

            // Store budget state
            this.state.budgets[group.id] = {
                total: budget.amount,
                used: covered,
                remaining: budget.amount - covered
            };
        }
    }

    /**
     * Apply deltas to currencies
     */
    applyDeltas(groupDeltas) {
        for (const groupId in groupDeltas) {
            for (const currencyId in groupDeltas[groupId]) {
                if (this.state.currencies[currencyId] !== undefined) {
                    this.state.currencies[currencyId] += groupDeltas[groupId][currencyId];
                }
            }
        }
    }

    // ==================== HELPERS ====================

    findItem(itemId) {
        for (const group of this.config.groups) {
            const item = group.items.find(i => i.id === itemId);
            if (item) return item;
        }
        return null;
    }

    findGroupForItem(itemId) {
        for (const group of this.config.groups) {
            if (group.items.find(i => i.id === itemId)) {
                return group;
            }
        }
        return null;
    }

    getSelectedInGroup(group) {
        return group.items.filter(i => this.state.selected.has(i.id));
    }

    // ==================== EVENTS ====================

    on(event, callback) {
        if (!this.listeners[event]) {
            this.listeners[event] = [];
        }
        this.listeners[event].push(callback);
    }

    emit(event, data) {
        if (this.listeners[event]) {
            this.listeners[event].forEach(cb => cb(data));
        }
    }

    // ==================== STATE MANAGEMENT ====================

    reset() {
        this.state.reset();
        this.recalculate();
        this.emit('reset');
        console.log('üîÑ State reset');
    }

    exportState() {
        return this.state.export();
    }

    importState(stateData) {
        this.state.import(stateData);
        this.recalculate();
        this.emit('import');
    }
}


============================================================
FILE START: src\core\rules.js
============================================================

/**
 * Rule Evaluator - Handles requirements, costs, and formulas
 */

export class RuleEvaluator {
    constructor(engine) {
        this.engine = engine;
    }

    // ==================== REQUIREMENTS ====================

    checkRequirements(item) {
        if (!item.requirements) return true;

        for (const req of item.requirements) {
            if (!this.evaluateRequirement(req, item)) {
                return false;
            }
        }

        return true;
    }

    evaluateRequirement(req, item) {
        // Complex formula
        if (req.includes('||') || req.includes('&&') || req.includes('(')) {
            return this.evaluateFormula(req, item, null);
        }

        // Negation: !item_id
        if (req.startsWith('!')) {
            const targetId = req.slice(1).trim();
            return !this.engine.state.selected.has(targetId);
        }

        // Simple: item_id
        return this.engine.state.selected.has(req.trim());
    }

    // ==================== INCOMPATIBLE ====================

    checkIncompatible(item) {
        if (!item.incompatible) return true;

        for (const badId of item.incompatible) {
            if (this.engine.state.selected.has(badId)) {
                return false;
            }
        }

        return true;
    }

    // ==================== COST EVALUATION ====================

    evaluateCost(cost, item, group) {
        let value = cost.value || cost.base || 0;

        if (cost.formula) {
            const formulaResult = this.evaluateFormula(cost.formula, item, group);
            value += formulaResult;
        }

        if (cost.condition) {
            const conditionResult = this.evaluateFormula(cost.condition, item, group);
            value += conditionResult;
        }

        return value;
    }

    // ==================== FORMULA EVALUATION ====================

    evaluateFormula(formula, item, group) {
        try {
            const context = this.createFormulaContext(item, group);
            const func = new Function(...Object.keys(context), `return ${formula};`);
            return func(...Object.values(context));
        } catch (error) {
            console.error('Formula error:', formula, error);
            return 0;
        }
    }

    createFormulaContext(item, group) {
        const state = this.engine.state;

        return {
            // Helper: has(id)
            has: (id) => state.selected.has(id),

            // Helper: selected object
            selected: {
                has: (id) => state.selected.has(id),
                length: state.selected.size
            },

            // Currencies
            currency: { ...state.currencies },

            // Counts per group
            count: this.createCountHelper(group),

            // Current group count
            this_group: group ? this.engine.getSelectedInGroup(group).length : 0,

            // Math functions
            Math: Math
        };
    }

    createCountHelper(currentGroup) {
        const counts = {};

        for (const group of this.engine.config.groups) {
            counts[group.id] = this.engine.getSelectedInGroup(group).length;
        }

        if (currentGroup) {
            counts.this_group = this.engine.getSelectedInGroup(currentGroup).length;
        }

        return counts;
    }
}


============================================================
FILE START: src\core\state.js
============================================================

/**
 * Game State - Manages current selection and currencies
 */

export class GameState {
    constructor(config) {
        this.config = config;
        this.reset();
    }

    reset() {
        this.selected = new Set();
        this.currencies = {};
        this.budgets = {};
        this.resetCurrencies();
    }

    resetCurrencies() {
        if (!this.config.points) {
            console.warn('No points defined in config');
            return;
        }

        this.config.points.forEach(p => {
            this.currencies[p.id] = p.start;
        });
    }

    export() {
        return {
            selected: Array.from(this.selected),
            currencies: { ...this.currencies },
            budgets: { ...this.budgets },
            timestamp: new Date().toISOString()
        };
    }

    import(data) {
        this.selected = new Set(data.selected || []);
        this.currencies = { ...data.currencies };
        this.budgets = { ...data.budgets };
    }
}


============================================================
FILE START: src\ui\controls.js
============================================================

/**
 * Control Panel - Handles UI controls (buttons, settings)
 */

import { CYOAEditor } from './editor.js';

export class ControlPanel {
    constructor(engine, renderer) {
        this.engine = engine;
        this.renderer = renderer;
        this.editor = new CYOAEditor(engine, renderer);

        this.setupControls();
        console.log('üéÆ Controls initialized');
    }

    // ==================== SETUP ====================

    setupControls() {
        // Text toggle
        const textBtn = document.getElementById('text-toggle');
        if (textBtn) {
            textBtn.addEventListener('click', () => this.toggleText());
        }

        // Edit/Debug toggle (Renamed)
        const editBtn = document.getElementById('edit-toggle');
        if (editBtn) {
            editBtn.addEventListener('click', () => this.toggleEditMode());
        }

        // Reset
        const resetBtn = document.getElementById('reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.reset());
        }
    }

    // ==================== ACTIONS ====================

    toggleText() {
        document.body.classList.toggle('text-mode');
        const btn = document.getElementById('text-toggle');
        if (btn) {
            btn.classList.toggle('active');
        }
    }

    toggleEditMode() {
        // Toggle the main edit class
        document.body.classList.toggle('edit-mode-active');
        
        const btn = document.getElementById('edit-toggle');
        if (btn) {
            btn.classList.toggle('active');
        }

        const isActive = document.body.classList.contains('edit-mode-active');
        
        // Enable/disable editor logic
        if (isActive) {
            this.editor.enable();
            // Also enable visual debug borders for items by default
            document.body.classList.add('show-zones'); 
        } else {
            this.editor.disable();
            document.body.classList.remove('show-zones');
            document.body.classList.remove('edit-mode-choice');
            document.body.classList.remove('edit-mode-group');
        }
        
        console.log(isActive ? '‚úèÔ∏è Edit mode ON' : '‚úèÔ∏è Edit mode OFF');
    }

    reset() {
        if (confirm('Reset all selections?')) {
            this.engine.reset();
            console.log('üîÑ Reset complete');
        }
    }
}


============================================================
FILE START: src\ui\editor.js
============================================================

/**
 * CYOA Editor - Visual editing mode
 */

import { CoordHelper } from '../utils/coords.js';
import { RuleBuilder } from './rule-builder.js';

export class CYOAEditor {
    constructor(engine, renderer) {
        this.engine = engine;
        this.renderer = renderer;
        this.ruleBuilder = new RuleBuilder(engine);
        
        this.selectedItem = null;
        this.selectedGroup = null;
        this.activeTab = 'choice'; 
        
        this.measureContext = document.createElement('canvas').getContext('2d');
        
        this.mirrorDiv = document.createElement('div');
        this.mirrorDiv.style.cssText = 'position:absolute; visibility:hidden; height:auto; overflow:hidden; white-space:pre-wrap; word-wrap:break-word;';
        document.body.appendChild(this.mirrorDiv);

        this.isDragging = false;
        this.isResizing = false;
        this.dragStart = { x: 0, y: 0 };
        this.initialRect = {};
        this.handleSize = 10;
        this.dragContext = null;
        
        this.enabled = false;
        console.log('‚úèÔ∏è Editor initialized');
    }

    enable() {
        if (this.enabled) return;
        this.enabled = true;
        this.createEditorUI();
        this.attachEventListeners();
        this.switchTab('choice');
        console.log('‚úèÔ∏è Editor enabled');
    }

    disable() {
        if (!this.enabled) return;
        this.enabled = false;
        const sidebar = document.getElementById('editor-sidebar');
        if (sidebar) sidebar.remove();
        this.removeEventListeners();
        document.querySelectorAll('.item-zone, .info-zone').forEach(el => {
            el.classList.remove('editable', 'editor-selected');
        });
        console.log('‚úèÔ∏è Editor disabled');
    }

    createEditorUI() {
        if (document.getElementById('editor-sidebar')) return;
        
        const sidebar = document.createElement('div');
        sidebar.id = 'editor-sidebar';
        sidebar.className = 'editor-sidebar';
        
        sidebar.innerHTML = `
            <div class="editor-tabs">
                <button class="tab-btn" data-tab="choice" onclick="CYOA.editor.switchTab('choice')">Choice</button>
                <button class="tab-btn" data-tab="group" onclick="CYOA.editor.switchTab('group')">Group</button>
                <button class="tab-btn" data-tab="settings" onclick="CYOA.editor.switchTab('settings')">Settings</button>
                <button class="close-tab-btn" onclick="CYOA.controls.toggleEditMode()">‚úï</button>
            </div>
            
            <div class="sidebar-scroll-content">
                
                <!-- TAB 1: CHOICE -->
                <div id="tab-content-choice" class="tab-content" style="display:none;">
                    <div id="choice-empty-state" class="info-text">
                        Select an item on the page to edit.
                    </div>

                    <div id="choice-props" style="display:none;">
                        <!-- Main Properties -->
                        <div class="editor-section">
                            <div class="row-2">
                                <div class="input-group">
                                    <input type="text" id="edit-id">
                                    <span class="input-label">ID</span>
                                </div>
                                <div class="input-group">
                                    <input type="text" id="edit-parent-group" readonly style="color:#888; cursor:default;">
                                    <span class="input-label">GRP</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" id="edit-title">
                                <span class="input-label">Title</span>
                            </div>
                            <div class="input-group">
                                <textarea id="edit-description" rows="7"></textarea>
                                <span class="input-label">Desc</span>
                            </div>
                        </div>

                        <!-- Position & Size -->
                        <div class="editor-section">
                            <div class="accordion-header" onclick="CYOA.editor.toggleAccordion(this)">
                                Position & Size
                            </div>
                            <div class="accordion-content">
                                <div class="row-4">
                                    <div class="input-group" title="X"><input type="number" id="edit-x"></div>
                                    <div class="input-group" title="Y"><input type="number" id="edit-y"></div>
                                    <div class="input-group" title="Width"><input type="number" id="edit-w"></div>
                                    <div class="input-group" title="Height"><input type="number" id="edit-h"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rule Builder -->
                        <div id="rule-builder-container"></div>

                        <!-- RAW JSON -->
                        <div class="editor-section">
                            <div class="accordion-header collapsed" onclick="CYOA.editor.toggleAccordion(this)">
                                üîß Raw JSON
                            </div>
                            <div class="accordion-content collapsed">
                                <textarea id="edit-raw-json" class="code-editor"></textarea>
                            </div>
                        </div>
                        
                        <!-- Actions Footer -->
                        <div class="editor-section" style="margin-top: 10px; border-top: 1px solid #222;">
                            <div class="row-buttons">
                                <button class="action-btn btn-delete" onclick="CYOA.editor.deleteSelectedItem()">üóëÔ∏è Delete</button>
                                <button class="action-btn btn-add" onclick="CYOA.editor.addNewItem()">‚ûï Add New</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: GROUP -->
                <div id="tab-content-group" class="tab-content" style="display:none;">
                    <div id="group-empty-state" class="info-text">
                        Select a group (Info Box) or a choice first.
                    </div>

                    <div id="group-props" style="display:none;">
                         <div class="editor-section">
                            <div class="input-group">
                                <input type="text" id="group-id">
                                <span class="input-label">Group ID</span>
                            </div>
                            <div class="input-group">
                                <input type="text" id="group-title">
                                <span class="input-label">Title</span>
                            </div>
                            <div class="input-group">
                                <textarea id="group-description" rows="7"></textarea>
                                <span class="input-label">Description</span>
                            </div>
                        </div>

                        <div class="editor-section">
                            <div class="accordion-header" onclick="CYOA.editor.toggleAccordion(this)">
                                Position & Size
                            </div>
                            <div class="accordion-content">
                                <div class="row-4">
                                    <div class="input-group" title="X"><input type="number" id="group-x"></div>
                                    <div class="input-group" title="Y"><input type="number" id="group-y"></div>
                                    <div class="input-group" title="Width"><input type="number" id="group-w"></div>
                                    <div class="input-group" title="Height"><input type="number" id="group-h"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Group Rules (JSON) -->
                         <div class="editor-section">
                             <div class="accordion-header" onclick="CYOA.editor.toggleAccordion(this)">
                                 üìú Group Rules (JSON)
                             </div>
                             <div class="accordion-content">
                                 <textarea id="group-rules-json" class="code-editor" style="height:150px;"></textarea>
                                 <div style="font-size:0.7rem; color:#666;">Format: {"max_choices": 1, "budget": {...}}</div>
                             </div>
                         </div>

                        <!-- Actions Footer -->
                        <div class="editor-section" style="margin-top: 10px; border-top: 1px solid #222;">
                            <div class="row-buttons">
                                <button class="action-btn btn-delete" onclick="CYOA.editor.deleteSelectedGroup()">üóëÔ∏è Delete Group</button>
                                <button class="action-btn btn-add" onclick="CYOA.editor.addNewGroup()">‚ûï Add Group</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: SETTINGS -->
                <div id="tab-content-settings" class="tab-content" style="display:none;">
                    <div class="editor-section">
                        <div class="accordion-header">File Operations</div>
                        <div class="accordion-content" style="display:block">
                            <button class="full-width-btn primary-btn" onclick="CYOA.editor.exportConfig()">üíæ Save JSON</button>
                        </div>
                    </div>
                </div>

            </div>
        `;
        
        document.body.appendChild(sidebar);
        this.ruleBuilder.renderUI(document.getElementById('rule-builder-container'));
        
        this.setupChoiceListeners();
        this.setupGroupListeners();
        this.setupJsonListeners();
        this.setupLabelAutoHiding();
    }

    switchTab(tabName) {
        this.activeTab = tabName;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(`tab-content-${tabName}`).style.display = 'block';

        document.body.classList.remove('edit-mode-choice', 'edit-mode-group');

        if (tabName === 'choice') {
            document.body.classList.add('edit-mode-choice');
            if (this.selectedItem) {
                this.updateChoiceInputs();
                document.getElementById('choice-empty-state').style.display = 'none';
                document.getElementById('choice-props').style.display = 'block';
            }
        } else if (tabName === 'group') {
            document.body.classList.add('edit-mode-group');
            if (this.selectedItem) {
                const group = this.engine.findGroupForItem(this.selectedItem.id);
                if (group) this.selectGroup(group);
            }
            if (this.selectedGroup) {
                document.getElementById('group-empty-state').style.display = 'none';
                document.getElementById('group-props').style.display = 'block';
            }
        }
    }

    toggleAccordion(header) {
        header.classList.toggle('collapsed');
        const content = header.nextElementSibling;
        content.classList.toggle('collapsed');
    }

    setupLabelAutoHiding() {
        const checkCollision = (input) => {
            const label = input.nextElementSibling;
            if (!label || !label.classList.contains('input-label')) return;
            const inputStyle = window.getComputedStyle(input);

            if (input.tagName === 'TEXTAREA') {
                this.mirrorDiv.style.font = inputStyle.font;
                this.mirrorDiv.style.width = inputStyle.width;
                this.mirrorDiv.style.padding = inputStyle.padding;
                this.mirrorDiv.textContent = input.value + '|';
                if (input.scrollHeight > input.clientHeight) {
                    label.classList.add('label-hidden');
                } else {
                     label.classList.remove('label-hidden');
                }
                return;
            }
            
            this.measureContext.font = inputStyle.font;
            const textWidth = this.measureContext.measureText(input.value).width;
            if ((textWidth + 10) > (input.clientWidth - label.offsetWidth - 10)) {
                label.classList.add('label-hidden');
            } else {
                label.classList.remove('label-hidden');
            }
        };

        const attach = () => {
             const inputs = document.querySelectorAll('#editor-sidebar input[type="text"], #editor-sidebar input[type="number"], #editor-sidebar textarea:not(.code-editor)');
             inputs.forEach(input => {
                input.removeEventListener('input', input._labelHandler);
                input._labelHandler = () => checkCollision(input);
                input.addEventListener('input', input._labelHandler);
                checkCollision(input);
             });
        };
        this.triggerLabelCheck = attach;
        setTimeout(attach, 500); 
    }

    attachEventListeners() {
        document.addEventListener('mousedown', this.handleMouseDown.bind(this));
        document.addEventListener('mousemove', this.handleMouseMove.bind(this));
        document.addEventListener('mouseup', this.handleMouseUp.bind(this));
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
    }

    removeEventListeners() {}

    handleMouseDown(e) {
        if (!this.enabled) return;
        if (e.target.closest('#editor-sidebar')) return;

        let target = null;
        let objectToEdit = null;

        if (this.activeTab === 'group') {
            target = e.target.closest('.info-zone');
            if (target) {
                const gid = target.id.replace('group-', '');
                const group = this.engine.config.groups.find(g => g.id === gid);
                if (group) {
                    this.selectGroup(group);
                    objectToEdit = group;
                }
            }
        } else {
            target = e.target.closest('.item-zone');
            if (target) {
                const itemId = target.dataset.itemId;
                const item = this.engine.findItem(itemId);
                if (item) {
                    this.selectChoice(item, target);
                    objectToEdit = item;
                    this.selectedGroup = this.engine.findGroupForItem(item.id);
                }
            } else if(this.activeTab === 'choice') {
                this.deselectChoice();
            }
        }

        if (objectToEdit && target) {
            target.classList.add('dragging');
            const rect = target.getBoundingClientRect();
            
            if (e.clientX >= rect.right - this.handleSize && e.clientY >= rect.bottom - this.handleSize) {
                this.isResizing = true;
            } else {
                this.isDragging = true;
            }
            
            this.dragStart = { x: e.clientX, y: e.clientY };
            if (!objectToEdit.coords) objectToEdit.coords = {x:0,y:0,w:100,h:100};
            this.initialRect = { ...objectToEdit.coords };
            
            const group = (objectToEdit.items) ? objectToEdit : this.engine.findGroupForItem(objectToEdit.id);
            const pageIndex = group?.page || 0;
            const dim = this.renderer.pageDimensions[pageIndex];
            const container = document.querySelector(`#page-${pageIndex}`);
            
            if (dim && container) {
                const containerRect = container.getBoundingClientRect();
                this.dragContext = {
                    scaleX: dim.w / containerRect.width,
                    scaleY: dim.h / containerRect.height,
                    dim: dim,
                    targetObj: objectToEdit
                };
            }
            e.preventDefault();
        }
    }

    handleMouseMove(e) {
        if (!this.enabled || !this.dragContext) return;
        if (!this.isDragging && !this.isResizing) return;
        
        const dx = e.clientX - this.dragStart.x;
        const dy = e.clientY - this.dragStart.y;
        const { scaleX, scaleY, dim, targetObj } = this.dragContext;
        
        if (this.isDragging) {
            targetObj.coords.x = Math.round(this.initialRect.x + dx * scaleX);
            targetObj.coords.y = Math.round(this.initialRect.y + dy * scaleY);
        } else if (this.isResizing) {
            targetObj.coords.w = Math.max(20, Math.round(this.initialRect.w + dx * scaleX));
            targetObj.coords.h = Math.max(20, Math.round(this.initialRect.h + dy * scaleY));
        }
        
        let domId = targetObj.items ? `group-${targetObj.id}` : `btn-${targetObj.id}`;
        const element = document.getElementById(domId);
        
        if (element) {
            const style = CoordHelper.toPercent(targetObj.coords, dim);
            Object.assign(element.style, style);
        }
        
        if (this.activeTab === 'group') this.updateGroupInputs();
        else this.updateChoiceInputs();
    }

    handleMouseUp() {
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        this.isDragging = false;
        this.isResizing = false;
        this.dragContext = null;
    }

    handleKeyDown(e) {
        if (!this.enabled) return;
        if (e.key === 'Delete') {
             const tag = document.activeElement.tagName;
             if (tag !== 'INPUT' && tag !== 'TEXTAREA') {
                 if (this.activeTab === 'choice') this.deleteSelectedItem();
             }
        }
    }

    selectChoice(item, element) {
        this.selectedItem = item;
        document.querySelectorAll('.editor-selected').forEach(el => el.classList.remove('editor-selected'));
        if(element) element.classList.add('editor-selected');
        
        document.getElementById('choice-empty-state').style.display = 'none';
        document.getElementById('choice-props').style.display = 'block';
        
        this.updateChoiceInputs();
        this.ruleBuilder.loadItem(item, this.engine.findGroupForItem(item.id));
    }

    deselectChoice() {
        this.selectedItem = null;
        document.querySelectorAll('.item-zone.editor-selected').forEach(el => el.classList.remove('editor-selected'));
        document.getElementById('choice-props').style.display = 'none';
        document.getElementById('choice-empty-state').style.display = 'block';
    }

    selectGroup(group) {
        this.selectedGroup = group;
        document.querySelectorAll('.info-zone.editor-selected').forEach(el => el.classList.remove('editor-selected'));
        const el = document.getElementById(`group-${group.id}`);
        if(el) el.classList.add('editor-selected');

        document.getElementById('group-empty-state').style.display = 'none';
        document.getElementById('group-props').style.display = 'block';
        
        this.updateGroupInputs();
    }

    updateChoiceInputs() {
        if (!this.selectedItem) return;
        const item = this.selectedItem;
        const group = this.engine.findGroupForItem(item.id);

        document.getElementById('edit-id').value = item.id || '';
        document.getElementById('edit-parent-group').value = group ? group.id : '?';
        document.getElementById('edit-title').value = item.title || '';
        document.getElementById('edit-description').value = item.description || '';
        
        ['x','y','w','h'].forEach(k => {
            document.getElementById(`edit-${k}`).value = Math.round(item.coords?.[k] || 0);
        });

        this.updateCodePreview();
        if (this.triggerLabelCheck) this.triggerLabelCheck();
    }

    updateGroupInputs() {
        if (!this.selectedGroup) return;
        const g = this.selectedGroup;

        document.getElementById('group-id').value = g.id || '';
        document.getElementById('group-title').value = g.title || '';
        document.getElementById('group-description').value = g.description || '';
        
        ['x','y','w','h'].forEach(k => {
            document.getElementById(`group-${k}`).value = Math.round(g.coords?.[k] || 0);
        });

        this.updateCodePreview();
        if (this.triggerLabelCheck) this.triggerLabelCheck();
    }

    updateCodePreview() {
        if (this.selectedItem) {
            const el = document.getElementById('edit-raw-json');
            if (el && document.activeElement !== el) {
                el.value = JSON.stringify(this.selectedItem, null, 2);
            }
        }
        if (this.selectedGroup) {
            const rulesEl = document.getElementById('group-rules-json');
            if (rulesEl && document.activeElement !== rulesEl) {
                rulesEl.value = JSON.stringify(this.selectedGroup.rules || {}, null, 2);
            }
        }
    }

    setupChoiceListeners() {
        const update = (key, val, isNum) => {
            if (!this.selectedItem) return;
            if (isNum) val = parseInt(val) || 0;
            if (['x','y','w','h'].includes(key)) {
                if (!this.selectedItem.coords) this.selectedItem.coords = {};
                this.selectedItem.coords[key] = val;
            } else {
                this.selectedItem[key] = val;
            }
            this.renderer.renderButtons();
            this.updateCodePreview();
        };

        const inputs = ['edit-id', 'edit-title', 'edit-description', 'edit-x', 'edit-y', 'edit-w', 'edit-h'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const key = id.split('-').pop();
            const realKey = (id === 'edit-description') ? 'description' : key;
            const isNum = ['x','y','w','h'].includes(key);
            el.addEventListener('input', (e) => update(realKey, e.target.value, isNum));
        });
    }

    setupGroupListeners() {
        const update = (key, val, isNum) => {
            if (!this.selectedGroup) return;
            if (isNum) val = parseInt(val) || 0;
            if (['x','y','w','h'].includes(key)) {
                if (!this.selectedGroup.coords) this.selectedGroup.coords = {};
                this.selectedGroup.coords[key] = val;
            } else {
                this.selectedGroup[key] = val;
            }
            this.renderer.renderButtons();
            this.updateCodePreview();
        };

        const inputs = ['group-id', 'group-title', 'group-description', 'group-x', 'group-y', 'group-w', 'group-h'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const key = id.split('-').pop();
            const realKey = (id === 'group-description') ? 'description' : key;
            const isNum = ['x','y','w','h'].includes(key);
            el.addEventListener('input', (e) => update(realKey, e.target.value, isNum));
        });
    }

    setupJsonListeners() {
        const choiceJson = document.getElementById('edit-raw-json');
        if (choiceJson) {
            choiceJson.addEventListener('change', (e) => {
                try {
                    const data = JSON.parse(e.target.value);
                    if (this.selectedItem) {
                        Object.assign(this.selectedItem, data);
                        this.renderer.renderButtons();
                        this.updateChoiceInputs();
                        this.ruleBuilder.loadItem(this.selectedItem, this.selectedGroup);
                    }
                } catch(err) { console.error("JSON Error", err); }
            });
        }

        const rulesJson = document.getElementById('group-rules-json');
        if (rulesJson) {
            rulesJson.addEventListener('change', (e) => {
                try {
                    const data = JSON.parse(e.target.value);
                    if (this.selectedGroup) {
                        this.selectedGroup.rules = data;
                        this.renderer.renderButtons(); 
                        this.engine.recalculate(); 
                    }
                } catch(err) { console.error("Rules JSON Error", err); }
            });
        }
    }

    deleteSelectedItem() {
        if (!this.selectedItem) return;
        if (!confirm('Delete item?')) return;
        const group = this.engine.findGroupForItem(this.selectedItem.id);
        if (group) {
            const idx = group.items.indexOf(this.selectedItem);
            if (idx > -1) group.items.splice(idx, 1);
        }
        this.deselectChoice();
        this.renderer.renderButtons();
    }

    addNewItem() {
        let group = this.selectedGroup || this.engine.config.groups[0];
        if (!group) return;
        const newItem = {
            id: `item_${Date.now()}`,
            title: 'New Item',
            description: '',
            coords: { x: 50, y: 50, w: 200, h: 100 },
            cost: []
        };
        group.items.push(newItem);
        this.renderer.renderButtons();
        setTimeout(() => {
            const el = document.getElementById(`btn-${newItem.id}`);
            if (el) this.selectChoice(newItem, el);
        }, 50);
    }

    // === GROUP ACTIONS ===
    addNewGroup() {
        const newGroup = {
            id: `group_${Date.now()}`,
            title: 'New Group',
            description: '',
            page: 0,
            coords: { x: 50, y: 50, w: 300, h: 200 },
            items: []
        };
        this.engine.config.groups.push(newGroup);
        this.renderer.renderButtons();
        setTimeout(() => {
            const el = document.getElementById(`group-${newGroup.id}`);
            if (el) this.selectGroup(newGroup);
        }, 50);
    }

    deleteSelectedGroup() {
        if (!this.selectedGroup) return;
        if (this.selectedGroup.items && this.selectedGroup.items.length > 0) {
            if (!confirm(`Group has ${this.selectedGroup.items.length} items. Delete group and ALL items?`)) return;
        } else {
            if (!confirm('Delete this group?')) return;
        }

        const idx = this.engine.config.groups.indexOf(this.selectedGroup);
        if (idx > -1) {
            this.engine.config.groups.splice(idx, 1);
        }
        
        // Deselect
        this.selectedGroup = null;
        document.querySelectorAll('.info-zone.editor-selected').forEach(el => el.classList.remove('editor-selected'));
        document.getElementById('group-props').style.display = 'none';
        document.getElementById('group-empty-state').style.display = 'block';
        
        this.renderer.renderButtons();
    }

    exportConfig() {
        const config = this.engine.config;
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${config.meta?.title || 'cyoa'}_edited.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
}


============================================================
FILE START: src\ui\renderer.js
============================================================

/**
 * UI Renderer - Handles all visual rendering
 */

import { CoordHelper } from '../utils/coords.js';
import { TooltipManager } from './tooltip.js';

export class UIRenderer {
    constructor(engine) {
        this.engine = engine;
        this.pageDimensions = [];
        this.tooltip = new TooltipManager(engine);

        // Listen to engine events
        this.engine.on('selection', () => this.updateUI());
        this.engine.on('recalculate', () => this.updateUI());
        this.engine.on('reset', () => this.updateUI());

        console.log('üé® Renderer initialized');
    }

    // ==================== MAIN RENDER ====================

    async renderAll() {
        await this.renderPages();
        this.renderButtons();
        this.renderPointsBar();
        console.log('‚úÖ All elements rendered');
    }

    // ==================== PAGES ====================

    async renderPages() {
        const wrapper = document.getElementById('game-wrapper');
        wrapper.innerHTML = '';
        this.pageDimensions = [];

        const pages = this.engine.config.meta?.pages || [];
        
        if (pages.length === 0) {
            console.warn('No pages defined in config');
            return;
        }

        console.log(`üìÑ Loading ${pages.length} page(s)...`);

        const loadPromises = pages.map((src, index) => {
            return new Promise((resolve) => {
                const container = document.createElement('div');
                container.className = 'page-container';
                container.id = `page-${index}`;

                const img = document.createElement('img');
                img.className = 'page-image';
                img.src = src;
                img.alt = `Page ${index + 1}`;

                const layer = document.createElement('div');
                layer.className = 'page-layer';
                layer.id = `layer-${index}`;

                container.appendChild(img);
                container.appendChild(layer);
                wrapper.appendChild(container);

                img.onload = () => {
                    this.pageDimensions[index] = {
                        w: img.naturalWidth,
                        h: img.naturalHeight
                    };
                    console.log(`‚úì Page ${index} loaded: ${img.naturalWidth}x${img.naturalHeight}`);
                    resolve();
                };

                img.onerror = () => {
                    console.error(`‚úó Failed to load page ${index}: ${src}`);
                    this.pageDimensions[index] = { w: 1920, h: 1080 };
                    resolve();
                };
            });
        });

        await Promise.all(loadPromises);
    }

    // ==================== BUTTONS ====================

    renderButtons() { 
        const pages = this.engine.config.meta?.pages || [];
        pages.forEach((_, index) => {
            const layer = document.getElementById(`layer-${index}`);
            if (layer) {
                layer.innerHTML = '';  
            }
        });

        const groups = this.engine.config.groups || [];
        
        console.log(`üîò Rendering buttons for ${groups.length} group(s)...`);

        groups.forEach(group => {
            const pageIndex = group.page !== undefined ? group.page : 0;
            const layer = document.getElementById(`layer-${pageIndex}`);
            
            if (!layer) {
                console.warn(`Layer not found for page ${pageIndex}`);
                return;
            }

            const dim = this.pageDimensions[pageIndex];
            if (!dim) {
                console.warn(`Dimensions not found for page ${pageIndex}`);
                return;
            }

            // Budget badge
            if (group.rules?.budget && group.coords) {
                this.renderBudgetBadge(group, layer, dim);
            }

            // Group info zone
            if (group.coords) {
                this.renderGroupZone(group, layer, dim);
            }

            // Items
            if (group.items) {
                group.items.forEach(item => {
                    if (item.coords) {
                        this.renderItemButton(item, group, layer, dim);
                    }
                });
            }
        });
    }

    // ==================== BUDGET BADGE ====================

    renderBudgetBadge(group, layer, dim) {
        const badge = document.createElement('div');
        badge.className = 'group-budget-badge';
        badge.id = `budget-${group.id}`;

        const style = CoordHelper.toPercent(group.coords, dim);
        const leftVal = parseFloat(style.left);
        const widthVal = parseFloat(style.width);
        const topVal = parseFloat(style.top);

        badge.style.left = (leftVal + widthVal / 2) + '%';
        badge.style.top = topVal + '%';

        layer.appendChild(badge);
        this.updateBudgetBadge(group);
    }

    updateBudgetBadge(group) {
        const badge = document.getElementById(`budget-${group.id}`);
        if (!badge) return;

        const budgetState = this.engine.state.budgets[group.id];
        if (!budgetState) {
            // Initial state before calculation
            const budget = group.rules.budget;
            badge.textContent = `${budget.name || budget.currency}: ${budget.amount}/${budget.amount}`;
            return;
        }

        const { total, remaining } = budgetState;
        const budget = group.rules.budget;
        badge.textContent = `${budget.name || budget.currency}: ${remaining}/${total}`;
        badge.classList.toggle('empty', remaining === 0);
    }

    // ==================== GROUP ZONE ====================

    renderGroupZone(group, layer, dim) {
        const zone = document.createElement('div');
        zone.className = 'click-zone info-zone';
        zone.id = `group-${group.id}`;

        Object.assign(zone.style, CoordHelper.toPercent(group.coords, dim));

        // Text layer for translation mode
        if (group.title || group.description) {
            zone.appendChild(this.createTextLayer(
                group.title || '',
                group.description || ''
            ));
        }

        layer.appendChild(zone);
    }

    // ==================== ITEM BUTTON ====================

    renderItemButton(item, group, layer, dim) {
        const button = document.createElement('div');
        button.className = 'click-zone item-zone';
        button.id = `btn-${item.id}`;
        button.dataset.itemId = item.id;
        button.dataset.groupId = group.id;

        Object.assign(button.style, CoordHelper.toPercent(item.coords, dim));

        // Text layer
        if (item.title || item.description) {
            button.appendChild(this.createTextLayer(
                item.title || '',
                item.description || ''
            ));
        }

        // Click handler
        button.onclick = () => {
            this.engine.toggle(item.id);
        };

        // Tooltip
        this.tooltip.attach(button, item, group);

        layer.appendChild(button);
    }

    // ==================== TEXT LAYER ====================

    createTextLayer(title, description) {
        const div = document.createElement('div');
        div.className = 'text-content';

        const cleanDesc = description ? 
            description.replace(/\n/g, '<br>') : '';

        div.innerHTML = `
            ${title ? `<strong>${title}</strong>` : ''}
            ${cleanDesc ? `<span>${cleanDesc}</span>` : ''}
        `;

        return div;
    }

    // ==================== POINTS BAR ====================

    renderPointsBar() {
        const bar = document.getElementById('points-bar');
        bar.innerHTML = '';

        const points = this.engine.config.points || [];

        points.forEach(p => {
            const div = document.createElement('div');
            div.className = 'currency';
            div.id = `curr-${p.id}`;
            div.innerHTML = `
                ${p.name}: 
                <span>${this.engine.state.currencies[p.id] || p.start}</span>
            `;
            bar.appendChild(div);
        });
    }

    // ==================== UPDATE UI ====================

    updateUI() {
        this.updateButtons();
        this.updatePointsBar();
        this.updateBudgets();
    }

    updateButtons() {
        document.querySelectorAll('.item-zone').forEach(el => {
            const itemId = el.dataset.itemId;
            const groupId = el.dataset.groupId;

            const item = this.engine.findItem(itemId);
            const group = this.engine.findGroupForItem(itemId);

            if (!item || !group) return;

            const isSelected = this.engine.state.selected.has(itemId);
            const canSelect = this.engine.canSelect(item, group);

            // Update classes
            el.classList.toggle('selected', isSelected);
            el.classList.toggle('disabled', !canSelect && !isSelected);
        });
    }

    updatePointsBar() {
        for (const currencyId in this.engine.state.currencies) {
            const span = document.querySelector(`#curr-${currencyId} span`);
            if (span) {
                const value = this.engine.state.currencies[currencyId];
                span.textContent = value;
                span.parentElement.classList.toggle('negative', value < 0);
            }
        }
    }

    updateBudgets() {
        for (const groupId in this.engine.state.budgets) {
            const group = this.engine.config.groups.find(g => g.id === groupId);
            if (group) {
                this.updateBudgetBadge(group);
            }
        }
    }
}


============================================================
FILE START: src\ui\rule-builder.js
============================================================

/**
 * Rule Builder - Visual rule editor
 */

export class RuleBuilder {
    constructor(engine) {
        this.engine = engine;
        this.currentItem = null;
        this.currentGroup = null;
    }

    // ==================== RENDER UI ====================

    renderUI(container) {
        container.innerHTML = `
            <!-- Cost Section -->
            <div class="editor-section">
                <div class="accordion-header" onclick="CYOA.editor.toggleAccordion(this)">
                    üí∞ Cost
                </div>
                <div class="accordion-content">
                    <div id="cost-list" class="compact-list"></div>
                    <button class="full-width-btn" onclick="CYOA.editor.ruleBuilder.addCost()">+ Add Cost</button>
                </div>
            </div>
            
            <!-- Requirements Section -->
            <div class="editor-section">
                <div class="accordion-header collapsed" onclick="CYOA.editor.toggleAccordion(this)">
                    ‚úÖ Requirements
                </div>
                <div class="accordion-content collapsed">
                    <div id="requirements-list" class="compact-list"></div>
                    <button class="full-width-btn" onclick="CYOA.editor.ruleBuilder.addRequirement()">+ Add Requirement</button>
                </div>
            </div>
            
            <!-- Incompatible Section -->
            <div class="editor-section">
                <div class="accordion-header collapsed" onclick="CYOA.editor.toggleAccordion(this)">
                    ‚ùå Incompatible
                </div>
                <div class="accordion-content collapsed">
                    <div id="incompatible-list" class="compact-list"></div>
                    <button class="full-width-btn" onclick="CYOA.editor.ruleBuilder.addIncompatible()">+ Add Incompatible</button>
                </div>
            </div>
        `;
    }

    loadItem(item, group) {
        this.currentItem = item;
        this.currentGroup = group;
        this.renderCosts();
        this.renderRequirements();
        this.renderIncompatible();
    }

    renderCosts() {
        if (!this.currentItem) return;
        const container = document.getElementById('cost-list');
        if (!container) return;
        const costs = this.currentItem.cost || [];
        if (costs.length === 0) {
            container.innerHTML = '<div style="color:#666; font-size:0.8rem; text-align:center; padding:2px;">No costs</div>';
            return;
        }
        container.innerHTML = costs.map((cost, index) => `
            <div class="compact-row">
                <select onchange="CYOA.editor.ruleBuilder.updateCostCurrency(${index}, this.value)" title="Currency">
                    ${this.getCurrencyOptions(cost.currency)}
                </select>
                <input type="text" value="${cost.value !== undefined ? cost.value : (cost.formula || 0)}" 
                       onchange="CYOA.editor.ruleBuilder.updateCostValueOrFormula(${index}, this.value)"
                       placeholder="Val">
                <button class="icon-btn" onclick="CYOA.editor.ruleBuilder.removeCost(${index})">√ó</button>
            </div>
        `).join('');
    }

    getCurrencyOptions(selected) {
        const currencies = this.engine.config.points || [];
        return currencies.map(c => 
            `<option value="${c.id}" ${c.id === selected ? 'selected' : ''}>
                ${c.name.substr(0, 10)}
            </option>`
        ).join('');
    }

    addCost() {
        if (!this.currentItem) return;
        if (!this.currentItem.cost) this.currentItem.cost = [];
        const firstCurrency = this.engine.config.points?.[0]?.id || 'points';
        this.currentItem.cost.push({ currency: firstCurrency, value: -1 });
        this.renderCosts();
        this.updateParent();
    }

    removeCost(index) {
        if (!this.currentItem?.cost) return;
        this.currentItem.cost.splice(index, 1);
        this.renderCosts();
        this.updateParent();
    }

    updateCostCurrency(index, value) {
        if (!this.currentItem?.cost?.[index]) return;
        this.currentItem.cost[index].currency = value;
        this.updateParent();
    }

    updateCostValueOrFormula(index, value) {
        if (!this.currentItem?.cost?.[index]) return;
        if (!isNaN(value) && value.trim() !== '') {
            this.currentItem.cost[index].value = parseInt(value);
            delete this.currentItem.cost[index].formula;
        } else {
            this.currentItem.cost[index].formula = value;
            delete this.currentItem.cost[index].value;
        }
        this.updateParent();
    }

    renderRequirements() {
        if (!this.currentItem) return;
        const container = document.getElementById('requirements-list');
        if (!container) return;
        const reqs = this.currentItem.requirements || [];
        if (reqs.length === 0) {
            container.innerHTML = '<div style="color:#666; font-size:0.8rem; text-align:center; padding:2px;">No requirements</div>';
            return;
        }
        container.innerHTML = reqs.map((req, index) => `
            <div class="compact-row" style="grid-template-columns: 1fr 24px;">
                <input type="text" value="${req}" 
                       onchange="CYOA.editor.ruleBuilder.updateRequirement(${index}, this.value)"
                       placeholder="item_id">
                <button class="icon-btn" onclick="CYOA.editor.ruleBuilder.removeRequirement(${index})">√ó</button>
            </div>
        `).join('');
    }

    addRequirement() {
        if (!this.currentItem) return;
        if (!this.currentItem.requirements) this.currentItem.requirements = [];
        this.currentItem.requirements.push('');
        this.renderRequirements();
        this.updateParent();
    }

    removeRequirement(index) {
        if (!this.currentItem?.requirements) return;
        this.currentItem.requirements.splice(index, 1);
        this.renderRequirements();
        this.updateParent();
    }

    updateRequirement(index, value) {
        if (!this.currentItem?.requirements) return;
        this.currentItem.requirements[index] = value;
        this.updateParent();
    }

    renderIncompatible() {
        if (!this.currentItem) return;
        const container = document.getElementById('incompatible-list');
        if (!container) return;
        const incomp = this.currentItem.incompatible || [];
        if (incomp.length === 0) {
            container.innerHTML = '<div style="color:#666; font-size:0.8rem; text-align:center; padding:2px;">No incompatibilities</div>';
            return;
        }
        container.innerHTML = incomp.map((id, index) => `
            <div class="compact-row" style="grid-template-columns: 1fr 24px;">
                <input type="text" value="${id}" 
                       onchange="CYOA.editor.ruleBuilder.updateIncompatible(${index}, this.value)"
                       placeholder="item_id">
                <button class="icon-btn" onclick="CYOA.editor.ruleBuilder.removeIncompatible(${index})">√ó</button>
            </div>
        `).join('');
    }

    addIncompatible() {
        if (!this.currentItem) return;
        if (!this.currentItem.incompatible) this.currentItem.incompatible = [];
        this.currentItem.incompatible.push('');
        this.renderIncompatible();
        this.updateParent();
    }

    removeIncompatible(index) {
        if (!this.currentItem?.incompatible) return;
        this.currentItem.incompatible.splice(index, 1);
        this.renderIncompatible();
        this.updateParent();
    }

    updateIncompatible(index, value) {
        if (!this.currentItem?.incompatible) return;
        this.currentItem.incompatible[index] = value;
        this.updateParent();
    }

    updateParent() {
        if (window.CYOA?.editor) {
            window.CYOA.editor.updateCodePreview();
            window.CYOA.editor.engine.recalculate();
            window.CYOA.editor.renderer.updateUI();
        }
    }
}


============================================================
FILE START: src\ui\tooltip.js
============================================================

/**
 * Tooltip Manager - Handles hover tooltips
 */

export class TooltipManager {
    constructor(engine) {
        this.engine = engine;
        this.tooltipEl = document.getElementById('tooltip');
        this.currentItem = null;
        this.currentGroup = null;
        this.timer = null;

        console.log('üí¨ Tooltip manager initialized');
    }

    // ==================== ATTACH ====================

    attach(element, item, group) {
        element.addEventListener('mouseenter', (e) => {
            this.currentItem = item;
            this.currentGroup = group;
            this.updateContent(item, group);
            this.updatePosition(e);

            // Delay show
            this.timer = setTimeout(() => {
                // Don't show if text mode is active
                if (!document.body.classList.contains('text-mode')) {
                    this.show();
                }
            }, 500);
        });

        element.addEventListener('mousemove', (e) => {
            this.updatePosition(e);
        });

        element.addEventListener('mouseleave', () => {
            this.hide();
            this.currentItem = null;
            this.currentGroup = null;
            clearTimeout(this.timer);
        });
    }

    // ==================== SHOW/HIDE ====================

    show() {
        this.tooltipEl.classList.add('visible');
    }

    hide() {
        this.tooltipEl.classList.remove('visible');
    }

    // ==================== CONTENT ====================

    updateContent(item, group) {
        const isDebug = document.body.classList.contains('debug-mode');
        let html = `<h4>${item.title}</h4>`;

        // Cost
        if (item.cost && item.cost.length > 0) {
            html += this.renderCost(item, group);
        }

        // Requirements
        html += this.renderRequirements(item, group);

        // Description (only if not in text mode)
        if (!document.body.classList.contains('text-mode') && item.description) {
            html += `<div class="desc">${item.description}</div>`;
        }

        // Debug info
        if (isDebug) {
            html += `<div class="debug-info">ID: ${item.id}<br>Group: ${group.id}</div>`;
        }

        this.tooltipEl.innerHTML = html;
    }

    // ==================== COST ====================

    renderCost(item, group) {
        let html = '';

        item.cost.forEach(c => {
            const finalVal = this.engine.rules.evaluateCost(c, item, group);
            const sign = finalVal > 0 ? '+' : '';
            
            let colorClass = finalVal < 0 ? 'bad' : '';
            if (finalVal === 0) colorClass = 'free';

            html += `<div class="cost ${colorClass}">${c.currency}: ${sign}${finalVal}</div>`;
        });

        return html;
    }

    // ==================== REQUIREMENTS ====================

    renderRequirements(item, group) {
        let reqsHtml = '';

        // Incompatible
        if (item.incompatible) {
            item.incompatible.forEach(badId => {
                if (this.engine.state.selected.has(badId)) {
                    const badItem = this.engine.findItem(badId);
                    reqsHtml += `<span class="req-item fail">‚ùå Incompatible with: ${badItem?.title || badId}</span>`;
                }
            });
        }

        // Max choices
        const isSelected = this.engine.state.selected.has(item.id);
        if (!isSelected && group.rules?.max_choices) {
            const currentCount = this.engine.getSelectedInGroup(group).length;
            if (currentCount >= group.rules.max_choices) {
                reqsHtml += `<span class="req-item fail">‚õî Max limit reached (${group.rules.max_choices})</span>`;
            }
        }

        // Requirements
        if (item.requirements) {
            item.requirements.forEach(req => {
                reqsHtml += this.renderRequirement(req);
            });
        }

        if (reqsHtml) {
            return `<div class="reqs">${reqsHtml}</div>`;
        }

        return '';
    }

    renderRequirement(req) {
        let isMet = false;
        let displayText = req;

        // Complex formula
        if (req.includes('(') || req.includes('||') || req.includes('&&')) {
            isMet = this.engine.rules.evaluateRequirement(req, null);
            
            // Make it readable
            displayText = displayText.replace(/has\(['"](.+?)['"]\)/g, (match, id) => {
                const item = this.engine.findItem(id);
                return item?.title || id;
            });
            displayText = displayText
                .replace(/\|\|/g, " <b style='color:#fff'>OR</b> ")
                .replace(/&&/g, " <b style='color:#fff'>AND</b> ");
        } else {
            // Simple requirement
            const isNot = req.startsWith('!');
            const cleanId = isNot ? req.slice(1) : req;
            isMet = this.engine.rules.evaluateRequirement(req, null);
            
            const targetItem = this.engine.findItem(cleanId);
            displayText = (isNot ? "NOT " : "") + (targetItem?.title || cleanId);
        }

        if (!isMet) {
            return `<span class="req-item missing">‚ö†Ô∏è Requires: ${displayText}</span>`;
        } else {
            return `<span class="req-item ok">‚úî ${displayText}</span>`;
        }
    }

    // ==================== POSITION ====================

    updatePosition(e) {
        const tt = this.tooltipEl;
        const ttH = tt.offsetHeight;
        const ttW = tt.offsetWidth;

        let top = e.clientY + 20;
        let left = e.clientX + 20;

        // Keep in viewport
        if (left + ttW > window.innerWidth) {
            left = window.innerWidth - ttW - 20;
        }

        if (top + ttH > window.innerHeight) {
            top = e.clientY - ttH - 10;
        }

        tt.style.top = top + 'px';
        tt.style.left = left + 'px';
    }
}


============================================================
FILE START: src\utils\coords.js
============================================================

/**
 * Coordinate Helper - Converts between pixels and percentages
 */

export class CoordHelper {
    /**
     * Convert coordinates to percentage
     * @param {Object|Array} coords - {x, y, w, h} or [x, y, w, h]
     * @param {Object} dimensions - {w, h} of image
     * @returns {Object} CSS style object
     */
    static toPercent(coords, dimensions) {
        if (!coords || !dimensions) {
            return { display: 'none' };
        }

        // Normalize to object
        const raw = Array.isArray(coords)
            ? { x: coords[0], y: coords[1], w: coords[2], h: coords[3] }
            : { ...coords };

        // Auto-detect: if any value > 100, assume pixels
        const isPixels = raw.x > 100 || raw.y > 100 || raw.w > 100 || raw.h > 100;

        if (isPixels) {
            return {
                left: (raw.x / dimensions.w * 100) + '%',
                top: (raw.y / dimensions.h * 100) + '%',
                width: (raw.w / dimensions.w * 100) + '%',
                height: (raw.h / dimensions.h * 100) + '%'
            };
        }

        // Already percentages
        return {
            left: raw.x + '%',
            top: raw.y + '%',
            width: raw.w + '%',
            height: raw.h + '%'
        };
    }

    /**
     * Convert coordinates to pixels
     */
    static toPixels(coords, dimensions) {
        const raw = Array.isArray(coords)
            ? { x: coords[0], y: coords[1], w: coords[2], h: coords[3] }
            : { ...coords };

        const isPixels = raw.x > 100 || raw.y > 100 || raw.w > 100 || raw.h > 100;

        if (isPixels) {
            return raw;
        }

        return {
            x: raw.x / 100 * dimensions.w,
            y: raw.y / 100 * dimensions.h,
            w: raw.w / 100 * dimensions.w,
            h: raw.h / 100 * dimensions.h
        };
    }
}


============================================================
FILE START: src\utils\evaluator.js
============================================================




============================================================
FILE START: styles\main.css
============================================================

/* ==========================================================================
   CYOA INTERACTIVE STYLES
   NOTE: Please keep CSS rules in SINGLE LINE format for compactness.
   Example: .class { property: value; property: value; }
   ========================================================================== */

/* === RESET & BASE === */
* { box-sizing: border-box; }
body { margin: 0; padding: 0 0 120px 0; background: #1a1a1a; color: #eee; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
#loading { transition: opacity 0.3s; }
#loading.hidden { opacity: 0; pointer-events: none; }

/* === TOP CONTROLS === */
.top-controls { position: fixed; top: 10px; right: 10px; z-index: 3000; display: flex; gap: 10px; }
.ctrl-btn { background: #333; color: #fff; border: 1px solid #555; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: all 0.2s; opacity: 0.85; font-weight: bold; }
.ctrl-btn:hover { opacity: 1; background: #444; transform: translateY(-1px); }
.ctrl-btn.active { background: #0066cc; border-color: #0088ff; opacity: 1; }

/* === GAME WRAPPER & PAGE === */
#game-wrapper { position: relative; max-width: 100%; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
.page-container { position: relative; margin-bottom: 0; line-height: 0; box-shadow: 0 0 30px rgba(0,0,0,0.5); max-width: 100%; }
.page-image { display: block; max-width: 100%; height: auto; user-select: none; }
.page-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; pointer-events: none; }

/* === CLICK ZONES & BUTTONS === */
.click-zone { position: absolute; cursor: pointer; z-index: 100; pointer-events: auto; border-radius: 12px; transition: all 0.2s; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; }
.click-zone:hover { background: rgba(255,255,255,0.07); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
.click-zone.selected { background: rgba(0,255,0,0.1); box-shadow: 0 0 15px 2px #0f0, inset 0 0 20px 5px rgba(0,255,0,0.3); }
.click-zone.disabled { cursor: not-allowed; background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.4), rgba(0,0,0,0.4) 10px, rgba(50,50,50,0.6) 10px, rgba(50,50,50,0.6) 20px); box-shadow: 0 0 15px 5px #000, inset 0 0 20px 10px rgba(0,0,0,0.8); }
.info-zone { z-index: 50; pointer-events: none; border: none; }
.info-zone .text-content { pointer-events: auto; }

/* === TEXT LAYER === */
.text-content { display: none; background: rgba(0,0,0,0.85); color: #ddd; padding: 10px; font-size: 14px; line-height: 1.4; max-height: 100%; overflow-y: auto; pointer-events: none; backdrop-filter: blur(2px); border-top: 1px solid #444; }
.text-content strong { display: block; color: #fff; font-size: 1.1em; margin-bottom: 4px; border-bottom: 1px solid #555; }
body.text-mode .text-content { display: block; pointer-events: auto; }

/* === BADGES & POINTS === */
.group-budget-badge { position: absolute; transform: translate(-50%, -50%); background: #000; border: 2px solid #ffd700; color: #ffd700; padding: 8px 20px; border-radius: 8px; font-weight: 800; font-size: 18px; z-index: 200; pointer-events: none; white-space: nowrap; box-shadow: 0 0 20px 2px rgba(255,215,0,0.6); }
.group-budget-badge.empty { border-color: #444; color: #666; background: rgba(0,0,0,0.8); box-shadow: none; }
#points-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #101010; border-top: 1px solid #333; padding: 15px; display: flex; justify-content: center; gap: 40px; box-shadow: 0 -5px 30px rgba(0,0,0,0.8); z-index: 2000; flex-wrap: wrap; }
.currency { font-size: 1.2em; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
.currency span { color: #00ff88; font-family: monospace; font-size: 1.3em; text-shadow: 0 0 5px rgba(0,255,100,0.5); }
.currency.negative span { color: #ff4444; text-shadow: 0 0 5px rgba(255,50,50,0.5); }

/* === TOOLTIP === */
#tooltip { position: fixed; z-index: 3000; background: rgba(10,10,10,0.95); border: 1px solid #444; padding: 15px; border-radius: 8px; pointer-events: none; font-size: 0.95em; max-width: 380px; box-shadow: 0 10px 40px #000; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.2s; color: #ccc; }
#tooltip.visible { opacity: 1; }
#tooltip h4 { margin: 0 0 8px 0; color: #fff; border-bottom: 1px solid #333; padding-bottom: 6px; }
#tooltip .cost { color: #0f0; font-weight: bold; margin-top: 8px; }
#tooltip .cost.bad { color: #f66; }
#tooltip .req-item.fail { color: #f88; font-weight: bold; }
#tooltip .req-item.ok { color: #666; text-decoration: line-through; }
#tooltip .debug-info { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #555; color: #777; font-size: 0.75em; font-family: monospace; }

/* === EDIT MODE VISUALS (Toggle via Edit Button) === */
body.show-zones .click-zone { border: 2px solid rgba(255,0,0,0.5) !important; background: rgba(255,0,0,0.05) !important; border-radius: 0 !important; box-shadow: none !important; }
body.show-zones .click-zone::after { content: attr(id); position: absolute; top: 0; left: 0; background: red; color: white; font-size: 10px; padding: 1px 3px; pointer-events: none; }
body.show-zones .info-zone { border: 2px dashed rgba(255,165,0,0.4) !important; background: rgba(255,165,0,0.1) !important; }

/* === EDIT MODE INTERACTION (Depends on active Tab) === */
body.edit-mode-choice .item-zone { pointer-events: auto; cursor: move; }
body.edit-mode-choice .info-zone { pointer-events: none; }
body.edit-mode-group .info-zone { pointer-events: auto; cursor: move; z-index: 2000; } 
body.edit-mode-group .item-zone { pointer-events: none; opacity: 0.5; }

/* === SELECTION HIGHLIGHTS === */
.item-zone.editor-selected { border: 3px solid #FFD700 !important; box-shadow: 0 0 20px rgba(255,215,0,0.5) !important; z-index: 3000; }
.info-zone.editor-selected { border: 3px solid #4CAF50 !important; background: rgba(76,175,80,0.2) !important; z-index: 3000; }
.editor-selected::after { content: ''; position: absolute; right: 0; bottom: 0; width: 15px; height: 15px; background: #fff; border: 1px solid #000; cursor: nwse-resize; pointer-events: none; }
.click-zone.dragging { transition: none !important; z-index: 9999 !important; pointer-events: none; opacity: 0.8; }

/* === EDITOR SIDEBAR LAYOUT === */
.editor-sidebar { background: #1a1a1a; width: 340px; position: fixed; right: 0; top: 0; bottom: 0; z-index: 4000; display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.5); border-left: 1px solid #333; }
body.edit-mode-active #game-wrapper { margin-right: 340px; transition: margin-right 0.3s; }

/* === EDITOR TABS === */
.editor-tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
.tab-btn { flex: 1; background: #111; border: none; color: #888; padding: 12px 0; cursor: pointer; font-weight: bold; font-size: 0.9rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab-btn:hover { color: #ccc; background: #181818; }
.tab-btn.active { color: #fff; background: #1a1a1a; border-bottom: 2px solid #4CAF50; }
.close-tab-btn { background: #d32f2f; color: white; border: none; width: 40px; flex-shrink: 0; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
.close-tab-btn:hover { background: #b71c1c; }

/* === EDITOR CONTENT (Stable Gutter + Offset Padding) === */
/* Padding right is reduced to 2px to account for the ~8px reserved gutter */
.sidebar-scroll-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 40px; padding-top: 15px; scrollbar-gutter: stable; scrollbar-width: thin; scrollbar-color: #444 transparent; }
.editor-section { padding: 5px 2px 5px 10px; width: 100%; box-sizing: border-box; border-bottom: 1px solid #222; }
.info-text { background: #252525; padding: 15px; border-radius: 4px; color: #aaa; font-size: 0.9rem; line-height: 1.4; text-align: center; margin: 10px; }

/* === FLOATING LABEL INPUTS === */
.input-group { position: relative; margin-bottom: 5px; width: 100%; background: #252525; border: 1px solid #333; border-radius: 4px; transition: border-color 0.2s; }
.input-group:focus-within { border-color: #4CAF50; background: #2a2a2a; }
.input-group input, .input-group textarea { width: 100%; background: transparent; border: none; color: #eee; padding: 6px 8px; font-size: 0.9rem; z-index: 2; position: relative; font-family: inherit; resize: vertical; display: block; }
.input-group input:focus, .input-group textarea:focus { outline: none; }
.input-label { position: absolute; right: 8px; color: #555; font-size: 0.75rem; pointer-events: none; font-weight: 600; text-transform: uppercase; z-index: 1; transition: opacity 0.2s; white-space: nowrap; }
.input-group input + .input-label { top: 50%; transform: translateY(-50%); }
.input-group textarea + .input-label { bottom: 6px; right: 8px; }
.input-label.label-hidden { opacity: 0 !important; }

/* === EDITOR UI HELPERS === */
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
.row-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; width: 100%; }
.row-4 .input-group input { text-align: center; padding: 6px 2px; }
.row-4 .input-label { display: none; }
.accordion-header { cursor: pointer; padding: 6px 0; display: flex; justify-content: space-between; color: #4CAF50; font-weight: bold; border-bottom: 1px solid #222; user-select: none; font-size: 0.9em; }
.accordion-header::after { content: '‚ñº'; font-size: 0.8em; transition: transform 0.2s; }
.accordion-header.collapsed::after { transform: rotate(-90deg); }
.accordion-content { display: block; overflow: hidden; padding: 5px 0; }
.accordion-content.collapsed { display: none; }
.row-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
.action-btn { width: 100%; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; border: none; font-size: 0.9rem; }
.btn-delete { background: #500; border: 1px solid #700; }
.btn-delete:hover { background: #700; }
.btn-add { background: #333; border: 1px solid #444; }
.btn-add:hover { background: #444; }
.primary-btn { background: #2e7d32; color: white; border: none; width: 100%; padding: 10px; border-radius: 4px; font-weight: bold; }

/* === RULE BUILDER & SCROLLBARS === */
.compact-list { display: flex; flex-direction: column; gap: 6px; width: 100%; }
.compact-row { display: grid; grid-template-columns: 35% 1fr 24px; gap: 4px; align-items: center; }
.compact-row select, .compact-row input { background: #222; border: 1px solid #333; color: #ddd; padding: 4px; border-radius: 3px; width: 100%; }
.icon-btn { background: #d32f2f; color: white; border: none; border-radius: 3px; width: 24px; height: 24px; cursor: pointer; }
.full-width-btn { width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: #ccc; cursor: pointer; border-radius: 4px; margin-top: 5px; font-weight: bold; font-size: 0.85rem; }
.code-editor { width: 100%; height: 200px; background: #111; color: #0f0; font-family: monospace; font-size: 0.8rem; border: 1px solid #333; border-radius: 4px; padding: 5px; box-sizing: border-box; resize: vertical; }
.code-editor:focus { outline: none !important; border-color: #4CAF50; box-shadow: none; }
/* Resizer: 70% gradient as requested */
::-webkit-resizer { background: linear-gradient(135deg, transparent 70%, #666 70%); }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #666; }

/* === MOBILE === */
@media (max-width: 1200px) { .editor-sidebar { width: 100%; max-width: 340px; } body.edit-mode-active #game-wrapper { margin-right: 0; } }
@media (max-width: 768px) { .top-controls { top: 5px; right: 5px; gap: 5px; } .ctrl-btn { padding: 6px 10px; font-size: 12px; } #points-bar { gap: 20px; padding: 10px; } }


============================================================
FILE START: styles\themes.css
============================================================



