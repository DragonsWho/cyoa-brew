<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYOA Generator (Fixed Standalone)</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #121212; 
            color: #eee; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .controls { 
            position: sticky;
            top: 20px;
            z-index: 100;
            margin-bottom: 20px; 
            display: flex; 
            gap: 15px; 
            background: rgba(30, 30, 30, 0.9); 
            backdrop-filter: blur(5px);
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #444; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        button { padding: 10px 20px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        .btn-render { background: #333; color: #fff; border: 1px solid #555; }
        .btn-render:hover { background: #444; }
        .btn-render.active { background: #4CAF50; color: #000; border-color: #4CAF50; }
        .btn-download { background: #2196F3; color: white; }
        .btn-download:hover { background: #1976D2; }
        
        canvas { 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            border: 1px solid #333; 
            max-width: 95%; 
            height: auto; 
            background: #000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button class="btn-render active" onclick="renderPage(0)">1. Render Page 0</button>
        <button class="btn-download" onclick="downloadImage('demo_page_1.jpg')">ðŸ’¾ Save Page 0</button>
        <div style="width: 1px; background: #555; margin: 0 5px;"></div>
        <button class="btn-render" onclick="renderPage(1)">2. Render Page 1</button>
        <button class="btn-download" onclick="downloadImage('demo_page_2.jpg')">ðŸ’¾ Save Page 1</button>
    </div>
    
    <canvas id="canvas" width="1920" height="1080"></canvas>

    <script>
        // ==========================================
        //  JSON DATA
        // ==========================================
        const cyoaData = {
 
  "pages": [
    {
      "id": "page_0",
      "image": "config/demo_page_1.jpg",
      "layout": [
        {
          "type": "group",
          "id": "section_basic",
          "title": "ðŸ“˜ SECTION 1: Basic Selection",
          "description": "Simple items with costs. Click to select, click again to deselect.",
          "coords": {
            "x": 38,
            "y": 22,
            "w": 1241,
            "h": 183
          },
          "items": [
            {
              "type": "item",
              "id": "basic_sword",
              "title": "Iron Sword",
              "description": "A basic weapon.\nCosts 10 points.",
              "coords": {
                "x": 52,
                "y": 80,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "combat"
              ]
            },
            {
              "type": "item",
              "id": "basic_shield",
              "title": "Wooden Shield",
              "description": "Basic protection.\nCosts 5 points.",
              "coords": {
                "x": 360,
                "y": 80,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -5
                }
              ],
              "tags": [
                "defense"
              ]
            },
            {
              "type": "item",
              "id": "free_item",
              "title": "Traveler's Cloak",
              "description": "Free item!\nNo cost.",
              "coords": {
                "x": 667,
                "y": 80,
                "w": 288,
                "h": 108
              },
              "cost": [],
              "tags": [
                "cloth"
              ]
            },
            {
              "type": "item",
              "id": "multi_currency",
              "title": "Enchanted Ring",
              "description": "Costs BOTH points AND gold.\n-15 Points, -20 Gold",
              "coords": {
                "x": 974,
                "y": 80,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -15
                },
                {
                  "currency": "gold",
                  "value": -20
                }
              ],
              "tags": [
                "magic"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_drawbacks",
          "title": "ðŸ“• SECTION 2: Drawbacks (Give Points)",
          "description": "These give you points in exchange for disadvantages.",
          "coords": {
            "x": 38,
            "y": 215,
            "w": 944,
            "h": 181
          },
          "items": [
            {
              "type": "item",
              "id": "drawback_weak",
              "title": "Physically Weak",
              "description": "You tire easily.\nGAINS +15 points!",
              "coords": {
                "x": 58,
                "y": 264,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": 15
                }
              ],
              "tags": [
                "drawback",
                "physical"
              ]
            },
            {
              "type": "item",
              "id": "drawback_poor",
              "title": "Penniless",
              "description": "Start with no money.\nGAINS +10 points, LOSES -50 gold",
              "coords": {
                "x": 366,
                "y": 264,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": 10
                },
                {
                  "currency": "gold",
                  "value": -50
                }
              ],
              "tags": [
                "drawback",
                "economic"
              ]
            },
            {
              "type": "item",
              "id": "drawback_cursed",
              "title": "Ancient Curse",
              "description": "Mysterious curse follows you.\nGAINS +20 points",
              "coords": {
                "x": 673,
                "y": 264,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": 20
                }
              ],
              "tags": [
                "drawback",
                "magical"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_max_choices",
          "title": "ðŸ“™ SECTION 3: Limited Choices (max_choices)",
          "description": "You can only pick ONE origin.",
          "coords": {
            "x": 38,
            "y": 405,
            "w": 945,
            "h": 188
          },
          "rules": {
            "max_choices": 1
          },
          "items": [
            {
              "type": "item",
              "id": "origin_warrior",
              "title": "Warrior Origin",
              "description": "Strong melee fighter.",
              "coords": {
                "x": 59,
                "y": 459,
                "w": 288,
                "h": 108
              },
              "cost": [],
              "tags": [
                "origin",
                "physical"
              ]
            },
            {
              "type": "item",
              "id": "origin_mage",
              "title": "Mage Origin",
              "description": "Powerful spellcaster.",
              "coords": {
                "x": 367,
                "y": 459,
                "w": 288,
                "h": 108
              },
              "cost": [],
              "tags": [
                "origin",
                "magical"
              ]
            },
            {
              "type": "item",
              "id": "origin_rogue",
              "title": "Rogue Origin",
              "description": "Sneaky and quick.",
              "coords": {
                "x": 674,
                "y": 459,
                "w": 288,
                "h": 108
              },
              "cost": [],
              "tags": [
                "origin",
                "agility"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_requirements",
          "title": "ðŸ“— SECTION 4: Requirements",
          "description": "These items require other selections first.",
          "coords": {
            "x": 38,
            "y": 605,
            "w": 1565,
            "h": 190
          },
          "items": [
            {
              "type": "item",
              "id": "req_base",
              "title": "Basic Magic",
              "description": "No requirements - select this first!",
              "coords": {
                "x": 61,
                "y": 662,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -5
                }
              ],
              "tags": [
                "magic"
              ]
            },
            {
              "type": "item",
              "id": "req_simple",
              "title": "Advanced Magic",
              "description": "REQUIRES: Basic Magic",
              "coords": {
                "x": 369,
                "y": 662,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "magic"
              ],
              "requirements": [
                "req_base"
              ]
            },
            {
              "type": "item",
              "id": "req_negative",
              "title": "Pure Light Spell",
              "description": "REQUIRES: NOT having Ancient Curse",
              "coords": {
                "x": 676,
                "y": 662,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -15
                }
              ],
              "tags": [
                "magic",
                "light"
              ],
              "requirements": [
                "!drawback_cursed"
              ]
            },
            {
              "type": "item",
              "id": "req_count_tag",
              "title": "Archmage Title",
              "description": "REQUIRES: 3+ magic items",
              "coords": {
                "x": 983,
                "y": 662,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -25
                }
              ],
              "requirements": [
                "count.tag('magic') >= 3"
              ],
              "tags": [
                "magic"
              ]
            },
            {
              "type": "item",
              "id": "req_or_logic",
              "title": "Combat Training",
              "description": "REQUIRES: Sword OR Shield",
              "coords": {
                "x": 1290,
                "y": 662,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "requirements": [
                "has('basic_sword') || has('basic_shield')"
              ],
              "tags": [
                "combat"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_incompatible",
          "title": "ðŸ““ SECTION 5: Incompatibilities",
          "description": "Some choices exclude others.",
          "coords": {
            "x": 38,
            "y": 799,
            "w": 954,
            "h": 196
          },
          "items": [
            {
              "type": "item",
              "id": "path_light",
              "title": "Path of Light",
              "description": "INCOMPATIBLE with Path of Darkness",
              "coords": {
                "x": 62,
                "y": 858,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "karma",
                  "value": 10
                }
              ],
              "incompatible": [
                "path_dark"
              ],
              "tags": [
                "path",
                "light"
              ]
            },
            {
              "type": "item",
              "id": "path_dark",
              "title": "Path of Darkness",
              "description": "INCOMPATIBLE with Path of Light",
              "coords": {
                "x": 370,
                "y": 858,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "karma",
                  "value": -10
                }
              ],
              "incompatible": [
                "path_light"
              ],
              "tags": [
                "path",
                "dark"
              ]
            },
            {
              "type": "item",
              "id": "path_balance",
              "title": "Path of Balance",
              "description": "INCOMPATIBLE with BOTH Light and Dark",
              "coords": {
                "x": 677,
                "y": 858,
                "w": 288,
                "h": 108
              },
              "cost": [],
              "incompatible": [
                "path_light",
                "path_dark"
              ],
              "tags": [
                "path",
                "balance"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "page_1",
      "image": "config/demo_page_2.jpg",
      "layout": [
        {
          "type": "group",
          "id": "section_effects",
          "title": "âš¡ SECTION 6: Effects",
          "description": "Items that modify the game when selected.",
          "coords": {
            "x": 38,
            "y": 22,
            "w": 1846,
            "h": 206
          },
          "items": [
            {
              "type": "item",
              "id": "effect_group_limit",
              "title": "Magic Backpack",
              "description": "Increases 'Limited Powers' choices by +2",
              "coords": {
                "x": 38,
                "y": 86,
                "w": 346,
                "h": 130
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -20
                }
              ],
              "tags": [
                "item"
              ],
              "effects": [
                {
                  "type": "modify_group_limit",
                  "group_id": "section_limited_powers",
                  "value": 2
                }
              ]
            },
            {
              "type": "item",
              "id": "effect_modify_cost_tag",
              "title": "Merchant's Ring",
              "description": "All 'wealth' items cost 50% less!",
              "coords": {
                "x": 422,
                "y": 86,
                "w": 346,
                "h": 130
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -15
                }
              ],
              "tags": [
                "item"
              ],
              "effects": [
                {
                  "type": "modify_cost",
                  "tag": "wealth",
                  "mode": "multiply",
                  "value": 0.5
                }
              ]
            },
            {
              "type": "item",
              "id": "effect_modify_cost_group",
              "title": "Guild Membership",
              "description": "All 'Skills' cost 5 less points",
              "coords": {
                "x": 806,
                "y": 86,
                "w": 346,
                "h": 130
              },
              "cost": [
                {
                  "currency": "gold",
                  "value": -30
                }
              ],
              "tags": [
                "social"
              ],
              "effects": [
                {
                  "type": "modify_cost",
                  "group_id": "section_skills",
                  "currency": "points",
                  "mode": "add",
                  "value": 5
                }
              ]
            },
            {
              "type": "item",
              "id": "effect_force_select",
              "title": "Cursed Artifact",
              "description": "Automatically selects 'Ancient Curse'!",
              "coords": {
                "x": 1190,
                "y": 86,
                "w": 346,
                "h": 130
              },
              "cost": [
                {
                  "currency": "points",
                  "value": 30
                }
              ],
              "tags": [
                "cursed"
              ],
              "effects": [
                {
                  "type": "force_selection",
                  "target_id": "drawback_cursed"
                }
              ]
            },
            {
              "type": "item",
              "id": "effect_roll_dice",
              "title": "Gambler's Die",
              "description": "Roll 1-20, add to points!",
              "coords": {
                "x": 1574,
                "y": 86,
                "w": 288,
                "h": 130
              },
              "cost": [],
              "tags": [
                "game"
              ],
              "effects": [
                {
                  "type": "roll_dice",
                  "min": 1,
                  "max": 20,
                  "currency": "points"
                }
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_limited_powers",
          "title": "ðŸ”® SECTION 7: Limited Powers (affected by Backpack)",
          "description": "Choose up to 2 powers",
          "coords": {
            "x": 38,
            "y": 238,
            "w": 1227,
            "h": 189
          },
          "rules": {
            "max_choices": 2
          },
          "items": [
            {
              "type": "item",
              "id": "power_fire",
              "title": "Fire Power",
              "description": "Control flames.",
              "coords": {
                "x": 38,
                "y": 302,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "power",
                "fire"
              ]
            },
            {
              "type": "item",
              "id": "power_ice",
              "title": "Ice Power",
              "description": "Control frost.",
              "coords": {
                "x": 346,
                "y": 302,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "power",
                "ice"
              ]
            },
            {
              "type": "item",
              "id": "power_lightning",
              "title": "Lightning Power",
              "description": "Control electricity.",
              "coords": {
                "x": 653,
                "y": 302,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "power",
                "electric"
              ]
            },
            {
              "type": "item",
              "id": "power_earth",
              "title": "Earth Power",
              "description": "Control stone.",
              "coords": {
                "x": 960,
                "y": 302,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "power",
                "earth"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_skills",
          "title": "ðŸ“š SECTION 8: Skills (affected by Guild Membership)",
          "description": "Learn skills.",
          "coords": {
            "x": 38,
            "y": 432,
            "w": 925,
            "h": 185
          },
          "items": [
            {
              "type": "item",
              "id": "skill_swordsmanship",
              "title": "Swordsmanship",
              "description": "Master the blade.",
              "coords": {
                "x": 38,
                "y": 497,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                }
              ],
              "tags": [
                "skill",
                "combat"
              ]
            },
            {
              "type": "item",
              "id": "skill_alchemy",
              "title": "Alchemy",
              "description": "Create potions.",
              "coords": {
                "x": 346,
                "y": 497,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -15
                }
              ],
              "tags": [
                "skill",
                "science"
              ]
            },
            {
              "type": "item",
              "id": "skill_stealth",
              "title": "Stealth",
              "description": "Move unseen.",
              "coords": {
                "x": 653,
                "y": 497,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -12
                }
              ],
              "tags": [
                "skill",
                "stealth"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_expensive",
          "title": "ðŸ’Ž SECTION 9: Expensive Items (affected by Ring)",
          "description": "Luxury items.",
          "coords": {
            "x": 38,
            "y": 626,
            "w": 925,
            "h": 183
          },
          "items": [
            {
              "type": "item",
              "id": "expensive_mansion",
              "title": "Grand Mansion",
              "description": "Luxurious home.",
              "coords": {
                "x": 40,
                "y": 677,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -40
                }
              ],
              "tags": [
                "wealth",
                "property"
              ]
            },
            {
              "type": "item",
              "id": "expensive_yacht",
              "title": "Private Yacht",
              "description": "Sail the seas.",
              "coords": {
                "x": 346,
                "y": 677,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -50
                }
              ],
              "tags": [
                "wealth",
                "vehicle"
              ]
            },
            {
              "type": "item",
              "id": "expensive_dragon",
              "title": "Pet Dragon",
              "description": "A loyal dragon.",
              "coords": {
                "x": 654,
                "y": 677,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -80
                }
              ],
              "tags": [
                "fantasy",
                "companion"
              ]
            }
          ]
        },
        {
          "type": "item",
          "id": "standalone_item",
          "title": "ðŸŒŸ Standalone Item",
          "description": "Not in any group.",
          "coords": {
            "x": 1120,
            "y": 671,
            "w": 422,
            "h": 130
          },
          "cost": [
            {
              "currency": "points",
              "value": -5
            }
          ],
          "tags": [
            "star"
          ]
        },
        {
          "type": "group",
          "id": "section_max_quantity",
          "title": "ðŸ”¢ SECTION 10: Quantity Items (max_quantity)",
          "description": "Items you can take multiple times.",
          "coords": {
            "x": 38,
            "y": 821,
            "w": 930,
            "h": 167
          },
          "items": [
            {
              "type": "item",
              "id": "qty_potion",
              "title": "Healing Potion",
              "description": "Buy up to 10!",
              "coords": {
                "x": 40,
                "y": 870,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -3
                }
              ],
              "max_quantity": 10,
              "tags": [
                "consumable"
              ]
            },
            {
              "type": "item",
              "id": "qty_training",
              "title": "Extra Training",
              "description": "Buy up to 5!",
              "coords": {
                "x": 346,
                "y": 870,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -10
                },
                {
                  "currency": "skill_points",
                  "value": 2
                }
              ],
              "max_quantity": 5,
              "tags": [
                "skill"
              ]
            },
            {
              "type": "item",
              "id": "qty_requires_multiple",
              "title": "Potion Master",
              "description": "REQUIRES: 5+ potions",
              "coords": {
                "x": 653,
                "y": 870,
                "w": 288,
                "h": 108
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -20
                }
              ],
              "requirements": [
                "qty('qty_potion') >= 5"
              ],
              "tags": [
                "special"
              ]
            }
          ]
        },
        {
          "type": "group",
          "id": "section_budget",
          "title": "ðŸ’° SECTION 11: Budget System",
          "description": "This group has 30 FREE points to spend!",
          "coords": {
            "x": 148,
            "y": 1009,
            "w": 703,
            "h": 151
          },
          "rules": {
            "budget": {
              "currency": "points",
              "amount": 30,
              "name": "Free Allowance"
            }
          },
          "items": [
            {
              "type": "item",
              "id": "budget_item_1",
              "title": "Budget Sword",
              "description": "Costs 15 points",
              "coords": {
                "x": 216,
                "y": 1044,
                "w": 272,
                "h": 98
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -15
                }
              ],
              "tags": [
                "combat"
              ]
            },
            {
              "type": "item",
              "id": "budget_item_2",
              "title": "Budget Shield",
              "description": "Costs 15 points",
              "coords": {
                "x": 540,
                "y": 1048,
                "w": 259,
                "h": 95
              },
              "cost": [
                {
                  "currency": "points",
                  "value": -15
                }
              ],
              "tags": [
                "defense"
              ]
            }
          ]
        }
      ]
    }
  ] 







        };

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function getColorByTag(tags) {
            if (!tags) return ['#444', '#666'];
            const t = tags[0]; 
            if (t.includes('drawback') || t.includes('cursed')) return ['#3a1a1a', '#d32f2f']; 
            if (t.includes('magic') || t.includes('fantasy')) return ['#1a1a3a', '#7b1fa2']; 
            if (t.includes('physical') || t.includes('combat') || t.includes('fire')) return ['#3a2a1a', '#e65100']; 
            if (t.includes('agility') || t.includes('stealth') || t.includes('defense')) return ['#1a3a1a', '#2e7d32']; 
            if (t.includes('ice') || t.includes('science')) return ['#1a2a3a', '#0288d1']; 
            if (t.includes('light') || t.includes('wealth') || t.includes('star')) return ['#3a3a1a', '#fbc02d']; 
            return ['#252525', '#555555'];
        }

        function renderPage(index) {
            document.querySelectorAll('.btn-render').forEach((b, i) => b.classList.toggle('active', i === index));
            
            const pageData = cyoaData.pages[index];
            if (!pageData) return;

            // 1. CALCULATE HEIGHT
            let maxY = 0;
            pageData.layout.forEach(entry => {
                const bottom = entry.coords.y + entry.coords.h;
                if (bottom > maxY) maxY = bottom;
            });

            const minHeight = 1080;
            const contentHeight = maxY + 50;
            canvas.height = Math.max(minHeight, contentHeight);

            // 2. BACKGROUND
            const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGradient.addColorStop(0, '#121212');
            bgGradient.addColorStop(1, '#1e1e24');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 3. GRID
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
            ctx.lineWidth = 1;
            const gridSize = 40;
            for(let x=0; x<canvas.width; x+=gridSize) { 
                ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); 
            }
            for(let y=0; y<canvas.height; y+=gridSize) { 
                ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); 
            }

            // 4. RENDER
            pageData.layout.forEach(entry => {
                if (entry.type === 'group') {
                    renderGroup(entry);
                } else if (entry.type === 'item') {
                    renderItem(entry); // FIXED: Checks for type="item" now
                }
            });
            
            console.log(`Rendered Page ${index}. Size: 1920x${canvas.height}`);
        }

        function renderGroup(group) {
            const { x, y, w, h } = group.coords;

            ctx.fillStyle = 'rgba(30, 30, 30, 0.6)';
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#333';
            ctx.fillRect(x, y, w, 30);
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#bbb';
            ctx.font = 'bold 16px "Segoe UI"';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'left';
            ctx.fillText(group.title.toUpperCase(), x + 10, y + 15);

            if (group.items) group.items.forEach(item => renderItem(item));
        }

        function renderItem(item) {
            const { x, y, w, h } = item.coords;
            const colors = getColorByTag(item.tags);
            
            ctx.fillStyle = '#2a2a2b';
            ctx.beginPath();
            if(ctx.roundRect) ctx.roundRect(x, y, w, h, 8); else ctx.rect(x, y, w, h);
            ctx.fill();
            
            ctx.strokeStyle = '#3a3a3a';
            ctx.lineWidth = 1;
            ctx.stroke();

            const imgH = h * 0.65;
            const grad = ctx.createLinearGradient(x, y, x, y + imgH);
            grad.addColorStop(0, colors[0]);
            grad.addColorStop(1, '#222');
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            if(ctx.roundRect) ctx.roundRect(x + 2, y + 2, w - 4, imgH, [6, 6, 0, 0]); else ctx.rect(x+2, y+2, w-4, imgH);
            ctx.fill();

            ctx.fillStyle = colors[1];
            ctx.fillRect(x + 2, y + imgH, w - 4, 3);

            ctx.fillStyle = '#eee';
            ctx.font = 'bold 18px "Segoe UI"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(item.title, x + w/2, y + imgH + 10);
        }

        function downloadImage(filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        window.onload = () => renderPage(0);
    </script>
</body>
</html>